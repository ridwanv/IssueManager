@page "/my-issues"

@using CleanArchitecture.Blazor.Application.Features.Issues.Caching
@using CleanArchitecture.Blazor.Application.Features.Issues.DTOs
@using CleanArchitecture.Blazor.Application.Features.Issues.Queries.GetMyAssignedIssues
@using CleanArchitecture.Blazor.Server.UI.Components.Issues
@using CleanArchitecture.Blazor.Server.UI.Components.UtcToLocalTime
@using CleanArchitecture.Blazor.Server.UI.Hubs
@using CleanArchitecture.Blazor.Server.UI.Services.SignalR
@using CleanArchitecture.Blazor.Domain.Enums
@using Microsoft.AspNetCore.SignalR.Client

@inject IStringLocalizer<MyIssues> L
@inject IMediator Mediator
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IPermissionService PermissionService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject SignalRConnectionService SignalRService
@implements IAsyncDisposable

@attribute [Authorize(Policy = Permissions.Issues.View)]
<PageTitle>@Title</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="pa-4">
    <MudStack Spacing="3">
        <!-- Header -->
        <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                <MudIcon Icon="@Icons.Material.Filled.AssignmentInd" Color="Color.Primary" Size="Size.Large" />
                <MudStack Spacing="0">
                    <MudText Typo="Typo.h5" Class="font-weight-bold">@Title</MudText>
                    <MudText Typo="Typo.body2" Class="mud-text-secondary">
                        Issues assigned to you
                    </MudText>
                </MudStack>
                <!-- Connection Status Indicator -->
                <MudChip T="string" Size="Size.Small" 
                        Color="@_connectionColor" 
                        Variant="Variant.Text"
                        Icon="@_connectionIcon"
                        Class="connection-status">
                    @_connectionStatus
                </MudChip>
            </MudStack>
            
            <MudStack Row Spacing="2">
                <MudButton Disabled="@_loading"
                           OnClick="@(() => OnRefresh())"
                           StartIcon="@Icons.Material.Outlined.Refresh"
                           Variant="Variant.Outlined"
                           Size="Size.Small">
                    @ConstantString.Refresh
                </MudButton>
            </MudStack>
        </MudStack>

        <!-- Issues Data Grid -->
        <MudDataGrid ServerData="@(ServerReload)"
                     FixedHeader="true"
                     FixedFooter="false"
                     Virtualize="false"
                     @bind-RowsPerPage="_defaultPageSize"
                     Loading="@_loading"
                     MultiSelection="true"
                     T="IssueListDto"
                     SelectOnRowClick="false"
                     RowClick="@(args => OnRowClick(args.Item))"
                     @bind-SelectedItems="_selectedItems"
                     Hover="true" @ref="_dataGrid">
            
            <Columns>
                <SelectColumn T="IssueListDto" />
                
                <PropertyColumn Property="x => x.ReferenceNumber" Title="@L["Reference"]" Sortable="true">
                    <CellTemplate>
                        <MudLink Href="@($"/issues/{context.Item.Id}")">
                            @context.Item.ReferenceNumber
                        </MudLink>
                    </CellTemplate>
                </PropertyColumn>
                
                <PropertyColumn Property="x => x.Title" Title="@L["Title"]" Sortable="true">
                    <CellTemplate>
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.body2">@context.Item.Title</MudText>
                            @if (!string.IsNullOrEmpty(context.Item.Description))
                            {
                                <MudText Typo="Typo.caption" Class="mud-text-secondary">
                                    @(context.Item.Description.Length > 50 ? context.Item.Description.Substring(0, 50) + "..." : context.Item.Description)
                                </MudText>
                            }
                        </MudStack>
                    </CellTemplate>
                </PropertyColumn>
                
                <PropertyColumn Property="x => x.Status" Title="@L["Status"]" Sortable="true">
                    <CellTemplate>
                        <IssueStatusBadge Status="@context.Item.Status" />
                    </CellTemplate>
                </PropertyColumn>
                
                <PropertyColumn Property="x => x.Priority" Title="@L["Priority"]" Sortable="true">
                    <CellTemplate>
                        <MudChip T="string" Size="Size.Small" Color="@GetPriorityColor(context.Item.Priority)" Variant="Variant.Text">
                            @context.Item.Priority.ToString()
                        </MudChip>
                    </CellTemplate>
                </PropertyColumn>
                
                <PropertyColumn Property="x => x.Category" Title="@L["Category"]" Sortable="true" />
                
                <PropertyColumn Property="x => x.ReporterName" Title="@L["Reporter"]" Sortable="false">
                    <CellTemplate>
                        <MudStack Spacing="0">
                            @if (!string.IsNullOrEmpty(context.Item.ReporterName))
                            {
                                <MudText Typo="Typo.body2">@context.Item.ReporterName</MudText>
                            }
                            @if (!string.IsNullOrEmpty(context.Item.ReporterPhone))
                            {
                                <MudText Typo="Typo.caption" Class="mud-text-secondary">@context.Item.ReporterPhone</MudText>
                            }
                        </MudStack>
                    </CellTemplate>
                </PropertyColumn>
                
                <PropertyColumn Property="x => x.Created" Format="yyyy-MM-dd HH:mm" Title="@L["Created"]" Sortable="true">
                    <CellTemplate>
                        @if (context.Item.Created.HasValue)
                        {
                            <UtcToLocal UTCDateTime="context.Item.Created.Value" Format="yyyy-MM-dd HH:mm" />
                        }
                    </CellTemplate>
                </PropertyColumn>
                
                <TemplateColumn CellClass="d-flex justify-end" Sortable="false">
                    <CellTemplate>
                        <MudIconButton Size="Size.Small" Icon="@Icons.Material.Outlined.Visibility" 
                                       OnClick="@(() => OnView(context.Item))" />
                        @if (_accessRights.Edit)
                        {
                            <MudIconButton Size="Size.Small" Icon="@Icons.Material.Outlined.Edit" 
                                           OnClick="@(() => OnEdit(context.Item))" />
                        }
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
            
            <NoRecordsContent>
                <MudStack AlignItems="AlignItems.Center" Spacing="2" Class="pa-8">
                    <MudIcon Icon="@Icons.Material.Outlined.Assignment" Size="Size.Large" Color="Color.Secondary" />
                    <MudText Typo="Typo.h6" Color="Color.Secondary">No issues assigned to you</MudText>
                    <MudText Typo="Typo.body2" Class="mud-text-secondary">
                        When issues are assigned to you, they will appear here.
                    </MudText>
                </MudStack>
            </NoRecordsContent>
            
            <LoadingContent>
                <MudText>@ConstantString.Loading</MudText>
            </LoadingContent>
            
            <PagerContent>
                <MudDataGridPager PageSizeOptions="@(new int[]{10,15,30,50,100})" />
            </PagerContent>
        </MudDataGrid>
    </MudStack>
</MudContainer>

<style>
    .connection-status {
        margin-left: 8px;
    }
    
    .connection-status .mud-chip-icon {
        animation: spin 2s linear infinite;
    }
    
    .connection-status.mud-chip-color-success .mud-chip-icon {
        animation: none;
    }
    
    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* Enhanced card styling */
    .mud-card {
        border-radius: 12px;
        border: 1px solid var(--mud-palette-lines-default);
    }
    
    .mud-card-header {
        border-bottom: 1px solid var(--mud-palette-lines-default);
    }
    
    /* Data grid styling */
    .mud-table-root {
        border-radius: 12px;
        overflow: hidden;
    }
    
    .mud-table-container {
        border-radius: 12px;
    }
</style>

@code {
    public string? Title { get; private set; }
    private int _defaultPageSize = 15;
    private HashSet<IssueListDto> _selectedItems = new();
    private MudDataGrid<IssueListDto> _dataGrid = default!;
    private bool _loading;
    private HubConnection? _hubConnection;
    
    // Real-time connection state
    private string _connectionStatus = "Connecting...";
    private Color _connectionColor = Color.Warning;
    private string _connectionIcon = Icons.Material.Filled.Sync;
    
    // SignalR handler disposables to avoid calling Remove(method) which clears other components' handlers
    private IDisposable? _issueCreatedHandler;
    private IDisposable? _issueUpdatedHandler;
    private IDisposable? _issueStatusChangedHandler;
    private IDisposable? _issueListUpdatedHandler;
    
    [CascadingParameter]
    private UserProfile? UserProfile { get; set; }

    private GetMyAssignedIssuesQuery _query { get; set; } = new();
    private IssuesAccessRights _accessRights = new();

    protected override async Task OnInitializedAsync()
    {
        Title = L["My Issues"];
        _accessRights = await PermissionService.GetAccessRightsAsync<IssuesAccessRights>();
        await InitializeSignalR();
    }

    private async Task InitializeSignalR()
    {
        try
        {
            // Use the SignalRConnectionService to get the connection
            await SignalRService.EnsureConnectedAsync();
            _hubConnection = SignalRService.HubConnection;

            if (_hubConnection != null)
            {
                // Connection state handlers
                _hubConnection.Reconnecting += OnReconnecting;
                _hubConnection.Reconnected += OnReconnected;
                _hubConnection.Closed += OnConnectionClosed;

                // Subscribe to real-time issue updates (store disposables so only this component unsubscribes its own handlers)
                _issueCreatedHandler = _hubConnection.On<IssueListDto>("IssueCreated", OnIssueCreated);
                _issueUpdatedHandler = _hubConnection.On<IssueListDto>("IssueUpdated", OnIssueUpdated);
                _issueStatusChangedHandler = _hubConnection.On<Guid, IssueStatus>("IssueStatusChanged", OnIssueStatusChanged);
                _issueListUpdatedHandler = _hubConnection.On("IssueListUpdated", OnIssueListUpdated);

                UpdateConnectionStatus("connected");
                Console.WriteLine($"[MyIssues] Successfully connected to SignalR and subscribed to issue events");
            }
            else
            {
                UpdateConnectionStatus("error");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"SignalR connection error: {ex.Message}");
            UpdateConnectionStatus("error");
        }
    }

    // Enhanced real-time event handlers
    private Task OnReconnecting(Exception? exception)
    {
        UpdateConnectionStatus("reconnecting");
        return Task.CompletedTask;
    }

    private Task OnReconnected(string? connectionId)
    {
        UpdateConnectionStatus("connected");
        return InvokeAsync(StateHasChanged);
    }

    private Task OnConnectionClosed(Exception? exception)
    {
        UpdateConnectionStatus("disconnected");
        return Task.CompletedTask;
    }

    private async Task OnIssueCreated(IssueListDto issue)
    {
        Console.WriteLine($"[MyIssues] Issue created: {issue.ReferenceNumber}");
        
        await InvokeAsync(async () =>
        {
            // Since we're filtering by assigned user in the query, any new issue 
            // creation that affects our list will require a reload to check assignment
            await _dataGrid.ReloadServerData();
            StateHasChanged();
        });
    }

    private async Task OnIssueUpdated(IssueListDto issue)
    {
        Console.WriteLine($"[MyIssues] Issue updated: {issue.ReferenceNumber}");
        
        await InvokeAsync(async () =>
        {
            // Reload the grid to get current assignment state since IssueListDto 
            // doesn't include assignment info
            await _dataGrid.ReloadServerData();
            StateHasChanged();
        });
    }

    private async Task OnIssueStatusChanged(Guid issueId, IssueStatus newStatus)
    {
        Console.WriteLine($"[MyIssues] Issue status changed: {issueId} -> {newStatus}");
        
        await InvokeAsync(async () =>
        {
            await _dataGrid.ReloadServerData();
            StateHasChanged();
        });
    }

    private async Task OnIssueListUpdated()
    {
        Console.WriteLine($"[MyIssues] Issue list updated - refreshing data");
        
        await InvokeAsync(async () =>
        {
            await _dataGrid.ReloadServerData();
            StateHasChanged();
        });
    }

    private void UpdateConnectionStatus(string status)
    {
        (_connectionStatus, _connectionColor, _connectionIcon) = status switch
        {
            "connected" => ("Connected", Color.Success, Icons.Material.Filled.CheckCircle),
            "reconnecting" => ("Reconnecting...", Color.Warning, Icons.Material.Filled.Sync),
            "disconnected" => ("Disconnected", Color.Error, Icons.Material.Filled.Error),
            "error" => ("Connection Error", Color.Error, Icons.Material.Filled.Error),
            _ => ("Unknown", Color.Default, Icons.Material.Filled.Help)
        };
        
        InvokeAsync(StateHasChanged);
    }

    private async Task<GridData<IssueListDto>> ServerReload(GridState<IssueListDto> state)
    {
        try
        {
            _loading = true;
            _query.CurrentUser = UserProfile;
            
            var sortDefinition = state.SortDefinitions.FirstOrDefault();
            _query.OrderBy = sortDefinition?.SortBy ?? "Created";
            _query.SortDirection = (sortDefinition != null && sortDefinition.Descending)
                                 ? SortDirection.Descending.ToString()
                                 : SortDirection.Ascending.ToString();
            _query.PageNumber = state.Page + 1;
            _query.PageSize = state.PageSize;
            
            var result = await Mediator.Send(_query).ConfigureAwait(false);
            return new GridData<IssueListDto>() { TotalItems = result.TotalItems, Items = result.Items };
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task OnRefresh()
    {
        IssueCacheKey.Refresh();
        await _dataGrid.ReloadServerData();
    }

    private void OnRowClick(IssueListDto item)
    {
        Navigation.NavigateTo($"/issues/{item.Id}");
    }

    private void OnView(IssueListDto item)
    {
        Navigation.NavigateTo($"/issues/{item.Id}");
    }

    private void OnEdit(IssueListDto item)
    {
        Navigation.NavigateTo($"/issues/{item.Id}/edit");
    }

    private static Color GetPriorityColor(IssuePriority priority)
    {
        return priority switch
        {
            IssuePriority.Low => Color.Success,
            IssuePriority.Medium => Color.Warning,
            IssuePriority.High => Color.Error,
            IssuePriority.Critical => Color.Error,
            _ => Color.Default
        };
    }

    // SignalR event handlers for my issues
    private async Task OnIssueAssignedToMe(IssueListDto issue)
    {
        Snackbar.Add($"New issue assigned to you: {issue.ReferenceNumber}", Severity.Info);
        await _dataGrid.ReloadServerData();
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnMyIssueUpdated(IssueListDto issue)
    {
        // Update the grid for any issue updates since we're filtering by assigned user already
        Snackbar.Add($"Your assigned issue updated: {issue.ReferenceNumber}", Severity.Info);
        await _dataGrid.ReloadServerData();
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnMyIssueStatusChanged(Guid issueId, IssueStatus newStatus)
    {
        await _dataGrid.ReloadServerData();
        await InvokeAsync(StateHasChanged);
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            if (_hubConnection != null)
            {
                // Dispose only handlers registered by this component (won't affect other components)
                _issueCreatedHandler?.Dispose();
                _issueUpdatedHandler?.Dispose();
                _issueStatusChangedHandler?.Dispose();
                _issueListUpdatedHandler?.Dispose();
                
                // Remove connection state handlers
                _hubConnection.Reconnecting -= OnReconnecting;
                _hubConnection.Reconnected -= OnReconnected;
                _hubConnection.Closed -= OnConnectionClosed;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error disposing SignalR handlers: {ex.Message}");
        }
        
        GC.SuppressFinalize(this);
    }
}