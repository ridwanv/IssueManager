@using ApexCharts
@using CleanArchitecture.Blazor.Application.Features.Issues.Queries.GetPerformanceStats
@using Microsoft.Extensions.Localization
@using CleanArchitecture.Blazor.Server.UI.Services
@using MudBlazor

@inject IStringLocalizer<HourlyDistributionChart> L
@inject LayoutService LayoutService

@if (HourlyData?.Any() == true)
{
    <ApexChart TItem="ChartDataPoint" 
               Options="Options" 
               @ref="Chart"
               Height="270">
        
        <ApexPointSeries TItem="ChartDataPoint"
                         Items="HourlyData"
                         Name="@L["Issues"]"
                         XValue="@(e => e.Label)"
                         YValue="@(e => (decimal)e.Value)"
                         SeriesType="SeriesType.Bar" />
    </ApexChart>
}
else
{
    <div class="d-flex justify-center align-center" style="height: 270px;">
        <MudText Typo="Typo.body1" Color="Color.Default">@L["No data available"]</MudText>
    </div>
}

@code {
    [Parameter] public List<ChartDataPoint> HourlyData { get; set; } = default!;

    private ApexChart<ChartDataPoint>? Chart;
    private ApexChartOptions<ChartDataPoint> Options = new();
    private bool _shouldRender = false;

    protected override Task OnParametersSetAsync()
    {
        if (HourlyData?.Any() == true)
        {
            SetupChartOptions();
            _shouldRender = true;
        }
        return Task.CompletedTask;
    }

    protected override Task OnAfterRenderAsync(bool firstRender)
    {
        // Let ApexChart handle its own rendering lifecycle
        // Manual Chart.RenderAsync() calls can cause race conditions and NullReferenceException
        return Task.CompletedTask;
    }

    private void SetupChartOptions()
    {
        var isDarkMode = LayoutService.IsDarkMode;
        var primaryColor = isDarkMode ? "#90CAF9" : "#1976D2";
        
        Options = new ApexChartOptions<ChartDataPoint>
        {
            Theme = new Theme { Mode = isDarkMode ? Mode.Dark : Mode.Light },
            Chart = new Chart { Background = "transparent" },
            Colors = new List<string> { primaryColor },
            Xaxis = new XAxis
            {
                Type = XAxisType.Category,
                Title = new AxisTitle { Text = L["Hour of Day"].ToString() }
            },
            Yaxis = new List<YAxis>
            {
                new YAxis
                {
                    Title = new AxisTitle { Text = L["Number of Issues"].ToString() },
                    Labels = new YAxisLabels
                    {
                        Formatter = @"function (value) {
                            return Math.round(value);
                        }"
                    }
                }
            },
            Tooltip = new Tooltip
            {
                Y = new TooltipY
                {
                    Formatter = @"function(value) { 
                        return Math.round(value) + ' issues'; 
                    }"
                }
            },
            DataLabels = new DataLabels
            {
                Enabled = false
            },
            Grid = new Grid
            {
                BorderColor = isDarkMode ? "#424242" : "#e0e0e0"
            }
        };
    }
}
