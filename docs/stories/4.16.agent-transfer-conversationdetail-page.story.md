# Story 4.16: Agent Transfer on ConversationDetail Page

## Status
Ready for Review

## Story
**As a** support agent with appropriate permissions,
**I want** to transfer an active conversation to another agent directly from the ConversationDetail page,
**so that** I can efficiently route conversations to more suitable agents based on expertise, workload, or availability while maintaining conversation context and ensuring seamless customer experience.

## Acceptance Criteria

1. **Agent Transfer UI on ConversationDetail Page**
   - ConversationDetail page includes a "Transfer to Agent" button/dropdown section
   - Transfer controls are only visible to agents with transfer permissions 
   - Transfer interface integrates seamlessly with existing conversation layout using MudBlazor components
   - Transfer controls are disabled for completed or closed conversations

2. **Agent Selection Interface**
   - Dropdown lists available agents within the same tenant with their current workload status
   - Shows agent availability status and current conversation count vs. maximum capacity
   - Prevents transfer to unavailable agents or those at maximum capacity
   - Displays agent specialization or team information if available for selection guidance

3. **Conversation ID Handling (Critical Requirement)**
   - If ConversationId parameter is string: lookup conversation by ConversationReference field
   - If ConversationId parameter is int: lookup conversation by Id field 
   - Transfer operations work correctly regardless of lookup method used
   - Error handling for invalid conversation references or IDs

4. **Transfer Action Processing**
   - Transfer button triggers transfer command with proper validation
   - Confirmation dialog before executing transfer to prevent accidental actions
   - Real-time UI updates when transfer completes successfully
   - Clear error messages if transfer fails due to validation or system issues

5. **Permission-Based Access Control**
   - Only agents with "CanTransferConversations" permission can access transfer controls
   - Transfer actions respect tenant isolation and role-based permissions
   - Audit logging for all transfer actions with user, timestamp, and reason
   - Cannot transfer conversations to agents outside current tenant boundary

6. **Real-Time Updates and Notifications**
   - SignalR notifications update all connected agents when transfers occur
   - Transfer notifications appear for both sending and receiving agents
   - ConversationDetail page redirects or updates after successful transfer
   - Visual indicators show transfer status during processing

## Tasks / Subtasks

- [x] **Task 1: Backend Transfer Command with ID Handling (AC: 3, 4, 5)**
  - [x] Create `TransferConversationCommand` with flexible conversation identification
  - [x] Implement conversation lookup logic for both string (ConversationReference) and int/Guid (Id) parameters
  - [x] Add agent validation and workload checks in `TransferConversationCommandHandler`
  - [x] Include permission validation and tenant isolation checks
  - [x] Add comprehensive audit logging for transfer actions

- [x] **Task 2: Enhanced Conversation Queries for Transfer Context (AC: 2, 3)**
  - [x] Extend existing conversation queries to support both ID types for lookup
  - [x] Modify `GetAvailableAgentsQuery` to include transfer-eligible agents with workload data
  - [x] Add conversation status validation to prevent transfers of closed conversations
  - [x] Implement caching for agent transfer data to improve UI performance

- [x] **Task 3: ConversationDetail Transfer UI Components (AC: 1, 4)**
  - [x] Add transfer section to existing ConversationDetail.razor page
  - [x] Create `AgentTransferDropdown` component with workload display and validation
  - [x] Implement `TransferConfirmationDialog` with transfer reason input
  - [x] Integrate transfer controls with existing page layout and permission checks

- [x] **Task 4: Transfer API Endpoint with Flexible ID Support (AC: 3, 4, 5)**
  - [x] Add `POST /api/conversations/{id}/transfer` endpoint to ConversationsController
  - [x] Support both string and numeric ID parameters in route handling
  - [x] Implement proper authorization attributes and permission validation
  - [x] Include OpenAPI documentation for transfer endpoint with ID type examples

- [x] **Task 5: SignalR Integration for Transfer Updates (AC: 6)**
  - [x] Extend ConversationHub with `ConversationTransferred` event
  - [x] Update ConversationDetail SignalR handlers for transfer notifications
  - [x] Add real-time transfer status updates during processing
  - [x] Integrate transfer notifications with existing agent notification system

- [x] **Task 6: Permission System Integration for Transfers (AC: 5)**
  - [x] Add `Transfer` permission to permissions system
  - [x] Update role configurations to include transfer permissions appropriately
  - [x] Implement permission checks in ConversationDetail UI components
  - [x] Add permission validation to all transfer-related API endpoints

## Dev Notes

### Previous Story Insights
From Story 4.15 (Conversation Assignment Management), the system has established patterns for:
- Agent selection dropdowns with workload display and validation
- Permission-based access control for conversation management actions
- SignalR integration for real-time assignment/transfer notifications
- Audit logging for conversation assignment operations

### Data Models

**Conversation Entity** [Source: architecture/data-models.md and existing stories]:
- Primary Key: `Id` (Guid) for database operations and tenant isolation
- `ConversationReference` (string) field for Bot Framework conversation identification
- Contains `CurrentAgentId` field for tracking assigned agent
- Includes `Status` field (ConversationStatus enum: Active, Escalated, Completed, Abandoned, Archived)
- Has audit fields (CreatedAt, UpdatedAt) for tracking changes
- Connected to ApplicationUser entities for agent relationships

**Agent/ApplicationUser Entity** [Source: architecture/data-models.md]:
- Contains `MaxConcurrentConversations` and `ActiveConversationCount` fields for workload management
- Has `CanTakeConversations` boolean for availability control
- Includes `Status` field for agent availability tracking
- Connected to tenant context for isolation

### API Specifications

**Transfer Endpoint Design** [Source: architecture/backend-architecture.md]:
- Must use Result<T> pattern for consistent error responses
- Controllers extend ApiControllerBase for standardized behavior
- Required `[MustHavePermission]` attributes for authorization
- Support flexible conversation identification in route parameter

**Request/Response Models**:
```csharp
public class TransferConversationRequest
{
    public string ToAgentId { get; set; }
    public string? Reason { get; set; }
    public bool ForceTransfer { get; set; } = false;
}

public class TransferResult
{
    public bool Success { get; set; }
    public string? ConversationId { get; set; }
    public string? FromAgentName { get; set; }
    public string? ToAgentName { get; set; }
    public string? ErrorMessage { get; set; }
}
```

### Component Specifications

**MudBlazor Components** [Source: architecture/components.md]:
- Use MudSelect for agent dropdown with custom item template showing workload
- MudButton for transfer action with proper loading states and permission visibility
- MudDialog for transfer confirmation with reason input field
- MudAlert for transfer status messages and validation errors

**ConversationDetail Page Integration**:
- Add transfer section alongside existing conversation controls
- Integrate with existing SignalR connection and event handlers
- Use established loading states and error handling patterns
- Maintain consistency with current page styling and layout

### File Locations

**Backend Files** [Source: architecture/unified-project-structure.md]:
- Commands: `src/Application/Features/Conversations/Commands/TransferConversation/`
- Controllers: `src/Server.UI/Controllers/ConversationsController.cs` (modify existing)
- DTOs: `src/Application/Features/Conversations/DTOs/` (extend existing)

**Frontend Files**:
- Page: `src/Server.UI/Pages/Conversations/ConversationDetail.razor` (modify existing)
- Components: `src/Server.UI/Components/Conversations/AgentTransferDropdown.razor`
- Dialogs: `src/Server.UI/Components/Conversations/TransferConfirmationDialog.razor`

### Testing Requirements

**Conversation ID Handling Tests** [Source: architecture/testing-strategy.md]:
- Unit tests for both string (ConversationReference) and int/Guid (Id) lookup scenarios
- Integration tests verifying correct conversation resolution for each ID type
- Error handling tests for invalid IDs and missing conversations
- Tenant isolation tests ensuring cross-tenant transfers are blocked

**Transfer Workflow Tests**:
- Agent validation with workload limits and availability checks
- Permission-based access control for transfer operations
- SignalR real-time update verification for transfer notifications
- End-to-end transfer workflow tests using Playwright framework

### Technical Constraints

**Database Access Pattern** [Source: architecture/coding-standards.md]:
- Use `IApplicationDbContextFactory` for all database access in handlers
- Ensure tenant isolation with automatic tenant filtering via `ITenantService`
- Support for both ConversationReference (string) and Id (Guid) lookups in same handler

**Flexible Conversation Identification**:
```csharp
// Handler must support both lookup methods
var conversation = await (IsGuid(conversationId) 
    ? db.Conversations.FirstOrDefaultAsync(c => c.Id == Guid.Parse(conversationId), ct)
    : db.Conversations.FirstOrDefaultAsync(c => c.ConversationReference == conversationId, ct));
```

**Security Requirements** [Source: architecture/coding-standards.md]:
- All transfer actions require permission validation
- Audit logging mandatory for transfer operations
- Tenant isolation must be maintained for all agent selections and transfers

**SignalR Integration** [Source: architecture/components.md]:
- Extend existing ConversationHub with transfer-specific events
- Use established SignalR connection service patterns from previous stories
- Maintain real-time update performance with targeted notifications

### Project Structure Notes
All file paths align with Clean Architecture structure:
- Transfer commands in Application layer following established CQRS pattern
- Controller modifications in Server.UI project with proper separation
- UI components follow existing Blazor Server project organization patterns
- Database access isolated through Infrastructure layer interfaces

## Testing

### Unit Tests Required
- `TransferConversationCommandHandler` tests with both ID type scenarios
- Conversation lookup logic tests for string vs Guid identification
- Agent validation tests with workload and availability checks
- Permission validation tests for transfer operations

### Integration Tests Required  
- Transfer API endpoints with flexible ID parameter handling
- Database transfer operations with tenant isolation validation
- SignalR hub transfer notifications for both sending and receiving agents
- Cross-agent transfer workflow with proper permission checks

### Component Tests Required
- `ConversationDetail` page transfer section rendering and interaction tests
- `AgentTransferDropdown` with workload display and validation tests
- `TransferConfirmationDialog` behavior and input validation tests
- Permission-based visibility tests for transfer controls

### E2E Tests Required
- Complete transfer workflow from ConversationDetail page to notification
- Both string and numeric conversation ID handling in full user journey
- Permission-based access control validation across different agent roles
- Real-time update propagation for transfer events across multiple sessions

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-20250514

### Debug Log References
- .ai/debug-log.md

### Completion Notes
- Task 1: Backend Transfer Command with ID Handling - ✅ Completed
- Task 2: Enhanced Conversation Queries for Transfer Context - ✅ Completed  
- Task 3: ConversationDetail Transfer UI Components - ✅ Completed
- Task 4: Transfer API Endpoint with Flexible ID Support - ✅ Completed
- Task 5: SignalR Integration for Transfer Updates - ✅ Completed
- Task 6: Permission System Integration for Transfers - ✅ Completed

### File List
- src/Application/Common/Security/Permissions.cs (Modified - Added Transfer permission)
- src/Application/Common/Interfaces/IApplicationHubWrapper.cs (Modified - Added BroadcastConversationTransferred method)
- src/Application/Features/Conversations/Commands/TransferConversation/TransferConversationCommand.cs (Created)
- src/Application/Features/Conversations/Commands/TransferConversation/TransferConversationCommandHandler.cs (Created)
- src/Application/Features/Conversations/Commands/TransferConversation/TransferConversationCommandValidator.cs (Created)
- src/Application/Features/Conversations/Queries/GetTransferEligibleAgents/GetTransferEligibleAgentsQuery.cs (Created)
- src/Application/Features/Conversations/Queries/GetConversationById/GetConversationByIdQuery.cs (Restored - flexible ID support)
- src/Server.UI/Hubs/ISignalRHub.cs (Modified - Added transfer notification methods)
- src/Server.UI/Hubs/ServerHubWrapper.cs (Modified - Implemented BroadcastConversationTransferred)
- src/Server.UI/Components/Conversations/AgentTransferDropdown.razor (Created)
- src/Server.UI/Components/Conversations/TransferConfirmationDialog.razor (Created)
- src/Server.UI/Pages/Agent/ConversationDetail.razor (Modified - Added transfer controls and handler)
- src/Server.UI/Controllers/ConversationsController.cs (Modified - Added transfer endpoint and request model)

### Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-09 | 1.0 | Initial story creation | Bob (Scrum Master) |