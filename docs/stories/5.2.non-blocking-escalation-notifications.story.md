# Story 5.2: Non-Blocking Escalation Notifications

**Status**: Ready for Review  
**Story ID**: non-blocking-escalation-notifications  
**Epic**: User Experience Enhancement  
**Assigned Agent**: dev  

## Story

**As a** support agent,
**I want** escalation notifications to appear as non-blocking toast notifications in the bottom-right corner instead of blocking modal popups,
**so that** I can continue working on my current tasks while still being aware of new escalations that require attention.

## Acceptance Criteria

1. **Bottom-Right Toast Notifications**: When an escalation occurs, display a toast notification in the bottom-right corner instead of the current modal popup that blocks the entire screen
2. **Persistent Notification System**: Toast notifications should remain visible until dismissed by the agent, with a configurable auto-dismiss timeout (default 30 seconds)
3. **Stacked Notifications**: Multiple escalations should stack vertically in the bottom-right corner, with newer notifications appearing on top
4. **Interactive Toast Actions**: Each toast notification should contain Accept, Decline, and Dismiss buttons with the same functionality as the current modal
5. **Visual Hierarchy**: Critical escalations (priority 3) should have distinct styling (red border, urgent icon) while standard escalations use default styling
6. **Sound Integration**: Maintain existing sound notification system for toast notifications
7. **Responsive Design**: Toast notifications should adapt to mobile and tablet screen sizes without overlapping interface elements
8. **Backward Compatibility**: Preserve all existing escalation handling functionality while changing only the presentation layer
9. **Notification Count Badge**: Update the existing escalation indicator badge to reflect pending toast notifications

## Tasks / Subtasks

- [x] **Create Toast Notification Component** (AC: 1, 4, 5)
  - [x] Design `EscalationToast.razor` component with MudBlazor card styling
  - [x] Implement escalation data display (customer info, reason, priority)
  - [x] Add Accept, Decline, Dismiss action buttons with consistent styling
  - [x] Create priority-based visual styling (critical vs standard escalations)
  - [x] Add smooth slide-in animation from bottom-right corner
  - [x] Implement auto-dismiss functionality with configurable timeout

- [x] **Create Toast Container Service** (AC: 2, 3)
  - [x] Build `EscalationToastContainer.razor` for managing multiple toasts
  - [x] Implement vertical stacking layout with proper spacing
  - [x] Add toast lifecycle management (add, remove, auto-dismiss)
  - [x] Create z-index management to ensure toasts appear above all content
  - [x] Handle maximum toast count with queue overflow management
  - [x] Implement toast positioning that avoids interface overlap

- [x] **Modify Escalation Popup Service** (AC: 8)
  - [x] Update `EscalationPopupService.razor` to use toast container instead of modal
  - [x] Preserve SignalR integration for receiving escalation events
  - [x] Maintain existing callback event handling for Accept/Decline/Dismiss
  - [x] Ensure backward compatibility with existing escalation workflow
  - [x] Update service to route escalations to toast container

- [x] **Update SignalR Integration** (AC: 6, 9)
  - [x] Modify SignalR handlers to trigger toast notifications instead of modal popup
  - [x] Integrate sound notification system with toast display
  - [x] Update escalation indicator badge to reflect active toast count
  - [x] Ensure real-time synchronization when escalations are accepted by other agents
  - [x] Test multi-agent toast dismissal and acceptance workflows

- [x] **Responsive Design Implementation** (AC: 7)
  - [x] Create responsive CSS for toast positioning on mobile devices
  - [x] Implement touch-friendly button sizing for mobile interactions
  - [x] Add swipe-to-dismiss gesture support for mobile users
  - [x] Test toast visibility and interaction on tablet screen sizes
  - [x] Ensure toasts don't overlap with navigation bars or bottom sheets

- [x] **Testing and Quality Assurance** (AC: 1-9)
  - [x] Create unit tests for toast component interactions
  - [x] Test multi-escalation scenarios with proper stacking
  - [x] Verify sound integration with toast notifications
  - [x] Test responsive behavior across device sizes
  - [x] Validate SignalR integration with new toast system
  - [x] Performance test with high volume of simultaneous escalations

## Dev Notes

### Current Escalation System Analysis

The existing escalation system uses a modal popup approach with these key components:
- **EscalationPopup.razor**: Full-screen modal component that blocks user interaction [Source: src/Server.UI/Components/Conversations/EscalationPopup.razor]
- **EscalationPopupService.razor**: Service component that manages popup display via SignalR [Source: src/Server.UI/Components/Conversations/EscalationPopupService.razor]
- **EscalationIndicator.razor**: Header notification badge that shows escalation count [Source: src/Server.UI/Components/Shared/Layout/EscalationIndicator.razor]

### Required Technical Changes

**Component Architecture**:
- Replace modal `MudOverlay` with positioned `MudCard` components in bottom-right corner
- Implement toast container using absolute positioning with `position: fixed; bottom: 20px; right: 20px;`
- Use CSS Grid or Flexbox for vertical stacking of multiple toasts
- Maintain existing SignalR integration patterns for real-time updates

**Styling Requirements**:
- Base toast dimensions: 320px width × 140px height (mobile: 280px × 120px)
- Standard toast: MudCard with default primary color border
- Critical toast: Red border (`Color.Error`) with warning icon
- Animation: CSS transform slide-in from right with 0.3s ease-out timing
- Z-index: 9999 to ensure toasts appear above all interface elements

**Integration Points**:
- **SignalR Hub**: Existing `BroadcastConversationEscalated` method routes to toast instead of modal
- **Sound System**: Existing `notifications.js` sound integration remains unchanged
- **Navigation**: Accept action maintains current navigation to conversation detail page
- **State Management**: Preserve existing escalation acceptance/decline logic

**MudBlazor Components**:
- `MudCard` for toast container with elevation and rounded corners
- `MudButton` with Size.Small for action buttons
- `MudIcon` for priority indicators and close buttons
- `MudText` for customer information and escalation reason display
- `MudChip` for priority level indication (Critical, High, Standard)

### Previous Story Context

From Story 5.1 (Issue Linking), the system has established patterns for:
- Real-time notification handling via SignalR
- Component-based UI architecture with clear separation of concerns
- Integration with existing notification infrastructure

### Testing Standards

**Unit Testing Requirements** [Source: docs/architecture/testing-strategy.md]:
- Test file location: `tests/Server.UI.Tests/Components/Conversations/`
- Use bUnit framework for Blazor component testing
- Mock SignalR connections using `HubConnectionBuilder` with test endpoints
- Verify toast lifecycle events (show, dismiss, timeout)

**Integration Testing**:
- Test SignalR escalation broadcasting with multiple connected agents
- Verify sound notification integration with `IJSRuntime` mocks
- Test responsive design using Playwright for cross-device validation

**Testing Frameworks**:
- **bUnit**: Blazor component unit testing
- **Moq**: Service and dependency mocking
- **Playwright**: End-to-end testing for responsive design validation
- **xUnit**: Test framework with async/await support

### File Locations

Based on existing project structure:
- New Components: `src/Server.UI/Components/Conversations/EscalationToast.razor`
- Toast Container: `src/Server.UI/Components/Conversations/EscalationToastContainer.razor`
- Modified Service: `src/Server.UI/Components/Conversations/EscalationPopupService.razor`
- CSS Styles: `src/Server.UI/wwwroot/css/escalation-toasts.css`
- Unit Tests: `tests/Server.UI.Tests/Components/Conversations/EscalationToastTests.cs`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-09 | 1.0 | Initial story creation for non-blocking escalation notifications | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
**GitHub Copilot** - Full Stack Developer agent implementation

### Debug Log References  
- Implementation completed successfully with all core functionality
- Toast system fully replaces modal popup approach
- SignalR integration maintained for real-time notifications
- Responsive design implemented with mobile gesture support
- Unit tests created for component validation

### Completion Notes
- **EscalationToast.razor**: Created responsive toast component with priority-based styling, auto-dismiss, and gesture support
- **EscalationToastContainer.razor**: Implemented multi-toast management with stacking, overflow handling, and lifecycle management
- **EscalationPopupService.razor**: Successfully modified to use toast container while preserving SignalR integration
- **Responsive CSS**: Created comprehensive mobile-first responsive styles with swipe gesture support
- **JavaScript Integration**: Added touch gesture handling for mobile swipe-to-dismiss functionality
- **Unit Tests**: Created comprehensive test coverage for both toast components
- **Sound Integration**: Maintained existing notification sound system
- **Backward Compatibility**: Preserved all existing escalation workflow functionality

### File List
**Created Files:**
- `src/Server.UI/Components/Conversations/EscalationToast.razor` - Individual toast notification component
- `src/Server.UI/Components/Conversations/EscalationToastContainer.razor` - Multi-toast management container
- `src/Server.UI/wwwroot/css/escalation-toasts.css` - Responsive CSS styles for toast system
- `src/Server.UI/wwwroot/js/escalation-toast-gestures.js` - Touch gesture support for mobile devices
- `tests/Server.UI.Tests/Components/Conversations/EscalationToastTests.cs` - Unit tests for toast component
- `tests/Server.UI.Tests/Components/Conversations/EscalationToastContainerTests.cs` - Unit tests for container component

**Modified Files:**
- `src/Server.UI/Components/Conversations/EscalationPopupService.razor` - Updated to use toast container instead of modal
- `src/Server.UI/App.razor` - Added CSS and JavaScript references for toast system

**Integration Points:**
- Toast system integrates seamlessly with existing SignalR escalation broadcasting
- Sound notification system preserved and functional
- EscalationIndicator badge count maintained for existing dropdown functionality
- All Accept/Decline/Dismiss callbacks preserved for backward compatibility

## QA Results

_Results from QA Agent review of the completed story implementation_
