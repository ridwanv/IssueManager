# Story 4.15: Conversation Assignment Management on Agent Dashboard

## Status
✅ **COMPLETED & DEPLOYED**

## Story
**As a** agent manager or supervisor,
**I want** to assign and re-assign escalated conversations to specific agents directly from the agent dashboard,
**so that** I can efficiently manage workload distribution, handle escalation assignments manually, and control auto-assignment behavior for optimal resource allocation.

## Acceptance Criteria

1. **Escalation Assignment Management UI on Agent Dashboard**
   - Agent dashboard displays escalated conversations with assignment controls for supervisors
   - Each escalated conversation shows current assignment status (unassigned, assigned agent name)
   - Assignment controls are only visible to users with supervisor/manager permissions
   - Auto-assignment toggle allows switching between manual and automatic assignment modes
   - Interface integrates seamlessly with existing agent dashboard escalation section using MudBlazor components

2. **Agent Assignment Interface for Escalated Conversations**
   - Assignment dropdown lists available agents with their current workload and availability status
   - Shows agent availability status and current conversation count vs. maximum capacity
   - Prevents assignment to unavailable agents or those at maximum capacity
   - Displays agent specialization or team information if available for optimal assignment decisions

3. **Conversation ID Handling (Critical Requirement from 4.16 Implementation)**
   - ConversationId as string parameter: lookup conversation by ConversationReference field
   - ConversationId as int parameter: lookup conversation by Id field
   - Assignment operations work correctly regardless of lookup method used
   - Error handling for invalid conversation references or IDs

4. **Assignment Action Processing**
   - Assign button triggers assignment command with proper validation using existing AssignAgentCommand
   - Re-assign functionality allows moving escalated conversations between agents
   - Confirmation dialog for re-assignment to prevent accidental changes
   - Real-time UI updates when assignments change via SignalR notifications

5. **Permission-Based Access Control for Supervisors**
   - Only users with "CanManageAssignments" permission can access assignment controls on dashboard
   - Assignment actions respect tenant isolation and role-based permissions
   - Audit logging for all assignment actions with user and timestamp
   - Cannot assign conversations to agents outside current tenant boundary

6. **Auto-Assignment Toggle and Round Robin**
   - Global auto-assignment toggle controls whether new escalations are automatically assigned
   - When auto-assign is enabled, system uses round-robin logic to distribute escalations to available agents
   - Manual assignment capability remains available even when auto-assign is enabled
   - Auto-assignment respects agent availability, workload limits, and capacity constraints

## Tasks / Subtasks

- [x] **Task 1: Extend Agent Dashboard for Supervisor Assignment Controls (AC: 1, 4, 5)**
  - [x] Modify existing `AgentDashboard.razor` to include assignment controls for escalated conversations
  - [x] Add supervisor permission checks to show/hide assignment functionality
  - [x] Integrate assignment dropdowns into existing escalated conversations section
  - [x] Implement confirmation dialogs for re-assignment actions

- [x] **Task 2: Create Assignment UI Components (AC: 1, 2, 4)**
  - [x] Create `ConversationAssignmentCard` component for individual escalated conversation assignment
  - [x] Build `AgentSelectionDropdown` component with workload display for supervisors  
  - [x] Implement `ReassignmentConfirmationDialog` for re-assignment validation
  - [x] Add auto-assignment toggle component with persistence

- [x] **Task 3: Enhanced Assignment Commands with ID Flexibility (AC: 3, 4)**
  - [x] Extend existing `AssignAgentCommand` to support both string (ConversationReference) and int (Id) lookups
  - [x] Create `ReassignAgentCommand` for moving conversations between agents
  - [x] Add supervisor permission validation in command handlers
  - [x] Implement audit logging for supervisor assignment actions

- [x] **Task 4: Auto-Assignment System Implementation (AC: 6)**
  - [x] Create `AutoAssignmentService` with round-robin logic for available agents
  - [x] Implement escalation event handler that triggers auto-assignment when enabled
  - [x] Add auto-assignment configuration persistence per tenant
  - [x] Integrate auto-assignment respecting agent availability and workload limits

- [x] **Task 5: Assignment API Endpoints for Dashboard (AC: 3, 4, 5)**
  - [x] Extend existing assignment endpoints in `ConversationsController` with supervisor permissions
  - [x] Add `POST /api/conversations/{id}/reassign-agent` endpoint for dashboard reassignment
  - [x] Implement `POST /api/assignment/toggle-auto-assign` endpoint for auto-assignment control
  - [x] Add proper authorization attributes for supervisor-level permissions

- [x] **Task 6: SignalR Integration for Supervisor Dashboard (AC: 4, 6)**
  - [x] Extend existing SignalR handlers in `AgentDashboard` for assignment notifications
  - [x] Update `ConversationHub` with supervisor-specific assignment events
  - [x] Integrate real-time updates for assignment changes and auto-assignment status
  - [x] Add workload updates that reflect assignment changes across all connected dashboards

## Dev Notes

### Implementation Based on Story 4.16 (Working Transfer System)
From Story 4.16 (Agent Transfer on ConversationDetail Page), the system has proven working patterns for:
- Flexible conversation ID handling (string ConversationReference vs int/Guid Id)
- `AssignAgentCommand` and `AssignAgentCommandHandler` already implemented and working
- SignalR integration with `BroadcastConversationAssigned` method in `IApplicationHubWrapper`
- Permission-based access control with tenant isolation
- Agent workload validation and capacity checking in assignment logic

### Current Agent Dashboard Implementation
From existing `AgentDashboard.razor` (Lines 180-214), the dashboard already has:
- Escalated conversations display with assignment status
- SignalR handlers for `ConversationAssigned` events (Line 570-582)
- Real-time updates for agent workload and availability
- Accept/Complete buttons for individual agent actions
- Integration with existing `GetEscalatedConversationsQuery` and `GetAvailableAgentsQuery`

### Data Models (Based on Working Implementation)
**Conversation Entity** [Source: Working AssignAgentCommand implementation]:
- Primary Key: `Id` (Guid) for database operations 
- `ConversationReference` (string) field for Bot Framework identification (used in AssignAgentCommand:38)
- Contains `CurrentAgentId` field for assignment tracking
- `Mode` field updated to ConversationMode.Human on assignment (AssignAgentCommand:62)
- `LastActivityAt` timestamp updated on assignment (AssignAgentCommand:63)

**Agent Entity** [Source: Working AssignAgentCommand implementation]:  
- Contains `MaxConcurrentConversations` and `ActiveConversationCount` fields
- `ActiveConversationCount` incremented on assignment (AssignAgentCommand:66)
- Has `CanTakeConversations` boolean validated before assignment (AssignAgentCommand:55-58)
- Connected to ApplicationUser for permission and display name lookup (AssignAgentCommand:84)

### API Specifications (Extend Existing Implementation)
**Assignment Command Pattern** [Source: Working AssignAgentCommand]:
- Use existing `AssignAgentCommand(string ConversationId, string AgentId)` pattern
- Command implements `ICacheInvalidatorRequest<Result<bool>>` for cache invalidation
- Handler uses `IApplicationDbContextFactory` for database access pattern
- SignalR notifications via `IApplicationHubWrapper.BroadcastConversationAssigned()`

**Supervisor Permission Requirements**:
```csharp
[MustHavePermission(Permissions.Conversations.CanManageAssignments)]
public async Task<IActionResult> AssignToAgent([FromRoute] string id, [FromBody] AssignAgentRequest request)
```

**Auto-Assignment Configuration**:
```csharp
public class AutoAssignmentSettings
{
    public bool IsEnabled { get; set; }
    public string TenantId { get; set; }
    public AssignmentStrategy Strategy { get; set; } = AssignmentStrategy.RoundRobin;
}
```

### Component Specifications (Extend Existing Dashboard)
**MudBlazor Integration** [Source: Existing AgentDashboard.razor]:
- Extend existing escalated conversations section (Lines 102-217) with assignment controls
- Use existing MudCard layout pattern for conversation display consistency
- Integrate MudSelect for agent dropdown with existing workload display patterns (Lines 73-97)
- Add MudSwitch for auto-assignment toggle alongside existing auto-assign switch (Lines 110-114)

**Agent Dashboard Extension** [Source: Working AgentDashboard patterns]:
- Extend existing escalated conversation cards with assignment dropdowns for supervisors
- Use existing SignalR connection (`_hubConnection`) and event handler patterns
- Integrate with existing loading states (`_loading`, `_processing`) and error handling
- Maintain current dashboard styling and MudGrid layout (Lines 58-223)

### File Locations (Implementation Completed)
**Backend Files Implemented**:
- ✅ Existing: `src/Application/Features/Conversations/Commands/AssignAgent/AssignAgentCommand.cs` (working)
- ✅ New: `src/Application/Features/Conversations/Commands/ReassignAgent/ReassignAgentCommand.cs` (properly handles both agents' counts)  
- ✅ New: `src/Application/Features/Conversations/Queries/GetAssignableAgents/GetAssignableAgentsQuery.cs`
- ✅ Extended: `src/Server.UI/Controllers/ConversationsController.cs` (supervisor endpoints added)
- ✅ New: `src/Infrastructure/Services/AutoAssignmentService.cs` (round-robin logic)
- ✅ Extended: `src/Application/Common/Security/Permissions.cs` (ManageAssignments permission)
- ✅ Extended: `src/Server.UI/Hubs/ServerHub.cs` and `ServerHubWrapper.cs` (assignment notifications)

**Frontend Files Implemented**:
- ✅ Modified: `src/Server.UI/Pages/Conversations/AgentDashboard.razor` (assignment controls added with @key fix)
- ✅ Created: `src/Server.UI/Components/Agent/ConversationAssignmentCard.razor` (uses DialogService)
- ✅ Created: `src/Server.UI/Components/Agent/ReassignAgentDialog.razor` (MudDialog component)
- ✅ Created: `src/Server.UI/Components/Shared/AgentSelectionDropdown.razor`

### Implementation Challenges & Solutions

**Challenge 1: Button Click Events Not Firing in Component Loop**
- **Problem**: `@onclick` events weren't working for buttons in `ConversationAssignmentCard` components
- **Root Cause**: Components rendered in `@foreach` loop without `@key` directive caused Blazor tracking issues
- **Solution**: Added `@key="conversation.Id"` to component in `AgentDashboard.razor` for proper component instance tracking
- **Files**: `src/Server.UI/Pages/Conversations/AgentDashboard.razor:143`

**Challenge 2: MudDialog Not Rendering Reliably**
- **Problem**: Inline `<MudDialog>` components with `IsVisible` binding weren't showing consistently
- **Root Cause**: Inline MudDialog components can have lifecycle and rendering issues in Blazor Server
- **Solution**: Replaced with `IDialogService.ShowAsync<T>()` approach using dedicated dialog component
- **Files**: `src/Server.UI/Components/Agent/ConversationAssignmentCard.razor`, `src/Server.UI/Components/Agent/ReassignAgentDialog.razor`

**Challenge 3: Conversation Count Not Decreasing on Reassignment**
- **Problem**: When reassigning conversation from Agent A to Agent B, Agent A's count wasn't decreasing
- **Root Cause**: UI was using `AssignAgentCommand` instead of proper `ReassignAgentCommand`
- **Solution**: Updated UI to use `ReassignAgentCommand` which properly handles both agents' counts
- **Files**: `src/Server.UI/Components/Agent/ConversationAssignmentCard.razor:230-233`

**Challenge 4: Build Errors with MudDialog Types**
- **Problem**: `MudDialogInstance` type not found compilation error
- **Root Cause**: Incorrect type name - should be `IMudDialogInstance` interface
- **Solution**: Corrected type and added proper `@using MudBlazor` directive
- **Files**: `src/Server.UI/Components/Agent/ReassignAgentDialog.razor:2,54`

### Testing Requirements
**Testing Strategy** [Source: architecture/testing-strategy.md]:
- Unit tests for assignment command handlers with validation scenarios
- Integration tests for assignment API endpoints with permission validation
- Component tests for assignment UI using bUnit framework
- E2E tests using Playwright for complete assignment workflow

**Specific Test Cases**:
- Assignment validation with workload limits
- Permission-based access control testing
- SignalR real-time update verification
- Cross-agent notification testing

### Technical Constraints
**Database Access** [Source: architecture/coding-standards.md]:
- Use `IApplicationDbContextFactory` for all database access in handlers
- Ensure tenant isolation with automatic tenant filtering via `ITenantService`
- Multi-database compatibility requires GUID primary keys in queries

**Security Requirements** [Source: architecture/coding-standards.md]:
- All assignment actions require permission validation
- Audit logging mandatory for assignment changes
- Tenant isolation must be maintained for all operations

**SignalR Integration** [Source: architecture/components.md]:
- Extend existing ConversationHub with assignment events
- Use existing SignalR connection service patterns
- Maintain real-time update performance with selective notifications

### Project Structure Notes
All file paths align with Clean Architecture structure:
- Commands and Queries in Application layer following CQRS pattern
- Controllers in Server.UI project with proper separation
- Components follow Blazor Server project organization
- Database access isolated through Infrastructure layer interfaces

## Testing

### Unit Tests Required
- `AssignConversationCommandHandler` tests with validation scenarios
- `ReassignConversationCommandHandler` tests with permission checks
- `GetAssignableAgentsQuery` tests with capacity filtering
- Agent assignment validation logic tests

### Integration Tests Required  
- Assignment API endpoints with permission validation
- Database assignment operations with tenant isolation
- SignalR hub assignment notifications
- Workload calculation accuracy tests

### Component Tests Required
- `ConversationAssignmentCard` rendering and interaction tests
- `AgentSelectionDropdown` with workload display tests
- Assignment confirmation dialog behavior tests
- Agent dashboard assignment section integration tests

### E2E Tests Required
- Complete assignment workflow from dashboard to notification
- Permission-based access control validation
- Real-time update propagation across multiple agent sessions
- Assignment workload management and validation

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-09 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-01-09 | 2.0 | Updated based on 4.16 implementation and supervisor focus - clarified ConversationId handling, shifted to agent manager/supervisor persona, integrated with existing working assignment system, added auto-assignment toggle functionality | Bob (Scrum Master) |
| 2025-01-15 | 3.0 | **COMPLETED**: All 6 tasks implemented with comprehensive supervisor assignment controls, auto-assignment system with round-robin logic, SignalR real-time updates, and supervisor-level API endpoints. Solution builds successfully and meets all acceptance criteria. | James (Dev Agent) |
| 2025-01-15 | 3.1 | **IMPLEMENTATION DETAILS**: Fixed critical bugs - added @key directive for component tracking in loops, replaced inline MudDialog with DialogService approach for reliability, corrected reassignment to use ReassignAgentCommand (properly updates both agents' conversation counts). All functionality tested and working. | James (Dev Agent) |
