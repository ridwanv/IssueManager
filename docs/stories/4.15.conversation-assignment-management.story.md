# Story 4.15: Conversation Assignment Management on Agent Dashboard

## Status
Draft

## Story
**As a** support agent with appropriate permissions,
**I want** to assign and re-assign conversations to agents directly from the agent dashboard,
**so that** I can efficiently manage workload distribution and ensure conversations are handled by the most suitable agents.

## Acceptance Criteria

1. **Conversation Assignment UI on Agent Dashboard**
   - Agent dashboard displays a "Manage Assignments" section with available conversations
   - Each conversation shows current assignment status (unassigned, assigned agent name)
   - Assignment controls are only visible to agents with assignment permissions
   - Interface integrates seamlessly with existing agent dashboard layout using MudBlazor components

2. **Agent Assignment Interface**
   - Dropdown or selection component lists available agents with their current workload
   - Shows agent availability status and current conversation count vs. maximum capacity
   - Prevents assignment to unavailable agents or those at maximum capacity
   - Displays agent specialization or team information if available

3. **Assignment Action Handling**
   - Assign button triggers assignment command with proper validation
   - Re-assign functionality allows moving conversations between agents
   - Confirmation dialog for re-assignment to prevent accidental changes
   - Real-time UI updates when assignments change

4. **Permission-Based Access Control**
   - Only agents with "CanAssignConversations" permission can access assignment controls
   - Assignment actions respect tenant isolation and role-based permissions
   - Audit logging for all assignment actions with user and timestamp

5. **Real-Time Updates and Notifications**
   - SignalR notifications update all connected agents when assignments change
   - Assignment notifications appear in notification indicator for affected agents
   - Dashboard refreshes assignment status without requiring page reload
   - Visual indicators show pending assignments and recent assignment changes

6. **Workload Management Integration**
   - Assignment interface shows current workload distribution across agents
   - Prevents over-assignment by validating against agent maximum capacity
   - Suggests optimal assignment based on agent availability and specialization
   - Integration with existing agent status and availability systems

## Tasks / Subtasks

- [ ] **Task 1: Backend Assignment Command and Validation (AC: 2, 4, 6)**
  - [ ] Create `AssignConversationCommand` with agent validation and workload checks
  - [ ] Implement permission validation in `AssignConversationCommandHandler`
  - [ ] Add workload validation to prevent over-assignment
  - [ ] Create `ReassignConversationCommand` for moving conversations between agents
  - [ ] Add audit logging for all assignment actions

- [ ] **Task 2: Enhanced Agent Query with Assignment Context (AC: 2, 6)**
  - [ ] Extend `GetAvailableAgentsQuery` to include current workload and capacity information
  - [ ] Add agent specialization and team data to agent DTOs
  - [ ] Create `GetAssignableAgentsQuery` with permission and capacity filtering
  - [ ] Implement caching for agent assignment data to improve performance

- [ ] **Task 3: Agent Dashboard Assignment UI Components (AC: 1, 3)**
  - [ ] Create `ConversationAssignmentCard` component for individual conversation assignment
  - [ ] Build `AgentSelectionDropdown` component with workload display
  - [ ] Implement `AssignmentConfirmationDialog` for re-assignment confirmation
  - [ ] Add assignment controls to existing escalated conversations section

- [ ] **Task 4: Assignment API Endpoints (AC: 3, 4)**
  - [ ] Add `POST /api/conversations/{id}/assign-agent` endpoint to ConversationsController
  - [ ] Implement `POST /api/conversations/{id}/reassign-agent` endpoint with validation
  - [ ] Add proper authorization attributes and permission checks
  - [ ] Include OpenAPI documentation for assignment endpoints

- [ ] **Task 5: SignalR Integration for Assignment Updates (AC: 5)**
  - [ ] Extend ConversationHub with `ConversationReassigned` event
  - [ ] Update agent dashboard SignalR handlers for assignment notifications
  - [ ] Integrate assignment updates with existing notification indicator
  - [ ] Add real-time workload updates for all connected agent dashboards

- [ ] **Task 6: Permission System Integration (AC: 4)**
  - [ ] Add `CanAssignConversations` permission to permissions system
  - [ ] Update role configurations to include assignment permissions
  - [ ] Implement permission checks in UI components to show/hide assignment controls
  - [ ] Add permission validation to all assignment-related API endpoints

## Dev Notes

### Previous Story Insights
From Story 4.12 (Agent Notification System), the system has established patterns for:
- SignalR integration with agent dashboard
- Agent notification handling and display
- Real-time updates for conversation events
- Integration with notification indicator component

### Data Models
**Conversation Entity** [Source: architecture/data-models.md]:
- Uses Guid primary keys for multi-tenant scenarios
- Contains `CurrentAgentId` field for assignment tracking
- Includes audit fields (CreatedAt, UpdatedAt) for tracking
- Has navigation properties to Agent and ApplicationUser entities

**Agent Entity** [Source: architecture/data-models.md]:
- Contains `MaxConcurrentConversations` and `ActiveConversationCount` fields
- Has `CanTakeConversations` boolean for availability control
- Includes `Status` field for agent availability tracking
- Connected to ApplicationUser for user details and permissions

### API Specifications
**Assignment Endpoints** [Source: architecture/backend-architecture.md]:
- All API endpoints must use Result<T> pattern for consistent error responses
- Controllers must extend ApiControllerBase for standardized behavior
- Required [MustHavePermission] attributes for authorization
- Proper HTTP status codes (200 for success, 400 for validation errors)

**Request/Response Models**:
```csharp
public class AssignConversationRequest
{
    public string AgentId { get; set; }
    public string? Notes { get; set; }
}

public class AssignmentResult
{
    public bool Success { get; set; }
    public string? ConversationId { get; set; }
    public string? AgentName { get; set; }
    public string? ErrorMessage { get; set; }
}
```

### Component Specifications
**MudBlazor Components** [Source: architecture/components.md]:
- Use MudSelect for agent dropdown with custom item template
- MudCard for assignment section integration with existing dashboard layout
- MudDialog for confirmation dialogs with proper button styling
- MudButton with proper loading states and permission-based visibility

**Agent Dashboard Integration** [Source: existing agent dashboard code]:
- Add assignment section alongside existing escalated conversations display
- Integrate with existing SignalR connection and event handlers
- Use existing loading states and error handling patterns
- Maintain consistency with current dashboard styling and layout

### File Locations
**Backend Files** [Source: architecture/unified-project-structure.md]:
- Commands: `src/Application/Features/Conversations/Commands/AssignConversation/`
- Queries: `src/Application/Features/Conversations/Queries/GetAssignableAgents/`
- Controllers: `src/Server.UI/Controllers/ConversationsController.cs`
- DTOs: `src/Application/Features/Conversations/DTOs/`

**Frontend Files**:
- Components: `src/Server.UI/Components/Agent/ConversationAssignmentCard.razor`
- Pages: `src/Server.UI/Pages/Conversations/AgentDashboard.razor` (modify existing)
- Shared Components: `src/Server.UI/Components/Shared/AgentSelectionDropdown.razor`

### Testing Requirements
**Testing Strategy** [Source: architecture/testing-strategy.md]:
- Unit tests for assignment command handlers with validation scenarios
- Integration tests for assignment API endpoints with permission validation
- Component tests for assignment UI using bUnit framework
- E2E tests using Playwright for complete assignment workflow

**Specific Test Cases**:
- Assignment validation with workload limits
- Permission-based access control testing
- SignalR real-time update verification
- Cross-agent notification testing

### Technical Constraints
**Database Access** [Source: architecture/coding-standards.md]:
- Use `IApplicationDbContextFactory` for all database access in handlers
- Ensure tenant isolation with automatic tenant filtering via `ITenantService`
- Multi-database compatibility requires GUID primary keys in queries

**Security Requirements** [Source: architecture/coding-standards.md]:
- All assignment actions require permission validation
- Audit logging mandatory for assignment changes
- Tenant isolation must be maintained for all operations

**SignalR Integration** [Source: architecture/components.md]:
- Extend existing ConversationHub with assignment events
- Use existing SignalR connection service patterns
- Maintain real-time update performance with selective notifications

### Project Structure Notes
All file paths align with Clean Architecture structure:
- Commands and Queries in Application layer following CQRS pattern
- Controllers in Server.UI project with proper separation
- Components follow Blazor Server project organization
- Database access isolated through Infrastructure layer interfaces

## Testing

### Unit Tests Required
- `AssignConversationCommandHandler` tests with validation scenarios
- `ReassignConversationCommandHandler` tests with permission checks
- `GetAssignableAgentsQuery` tests with capacity filtering
- Agent assignment validation logic tests

### Integration Tests Required  
- Assignment API endpoints with permission validation
- Database assignment operations with tenant isolation
- SignalR hub assignment notifications
- Workload calculation accuracy tests

### Component Tests Required
- `ConversationAssignmentCard` rendering and interaction tests
- `AgentSelectionDropdown` with workload display tests
- Assignment confirmation dialog behavior tests
- Agent dashboard assignment section integration tests

### E2E Tests Required
- Complete assignment workflow from dashboard to notification
- Permission-based access control validation
- Real-time update propagation across multiple agent sessions
- Assignment workload management and validation

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-09 | 1.0 | Initial story creation | Bob (Scrum Master) |
