# Story 4.15: Persistent Escalation Notification Icon

## Status
**Approved**

## Story
**As a** support agent,
**I want** a persistent blinking notification icon next to the messages icon that continues to blink even when I click "ignore" on an escalation popup,
**so that** I don't forget about pending escalations until someone actually accepts and handles them.

## Acceptance Criteria
1. When a conversation is escalated, a blinking notification icon appears next to the messages icon in the top header bar
2. The blinking icon persists even when agents click "Ignore" on the escalation popup (EscalationPopup.razor)
3. The notification icon shows the count of unaccepted escalations waiting for agent response
4. Clicking the notification icon shows a list of pending escalations with customer context
5. The notification only stops blinking when an escalation is actually accepted by someone
6. Multiple escalations accumulate in the notification count until individually accepted
7. The icon integrates seamlessly with the existing NotificationIndicator component in HeaderMenu.razor
8. Real-time updates ensure all agents see the persistent notification until resolution

## Tasks / Subtasks

- [ ] **Enhance EscalationPopup Component** (AC: 2, 5)
  - [ ] Modify `IgnoreEscalation()` method to NOT remove escalation from persistent notification tracking
  - [ ] Add SignalR event to broadcast escalation persistence to all agents when ignored
  - [ ] Update escalation state management to distinguish between "ignored by individual" vs "accepted by someone"

- [ ] **Enhance NotificationIndicator Component** (AC: 1, 3, 4, 6, 7)
  - [ ] Add separate escalation notification tracking alongside existing conversation notifications
  - [ ] Create escalation-specific notification items with customer context and escalation reason
  - [ ] Implement escalation count display in notification badge
  - [ ] Add escalation section to notification dropdown menu with "Accept" action buttons

- [ ] **Extend SignalR Hub Integration** (AC: 8)
  - [ ] Add `EscalationIgnored` SignalR event to maintain notification persistence across all agents
  - [ ] Modify existing `BroadcastConversationEscalated` to trigger persistent notifications
  - [ ] Add `EscalationPersistentNotificationCleared` event when someone actually accepts
  - [ ] Ensure real-time synchronization of escalation notification state across all connected agents

- [ ] **Update Application Layer Commands** (AC: 5)
  - [ ] Modify `AcceptEscalationCommand` to clear persistent notifications for all agents
  - [ ] Add escalation tracking to existing notification preference system
  - [ ] Ensure tenant isolation for escalation notifications

- [ ] **Add CSS Enhancements** (AC: 1, 7)
  - [ ] Enhance existing blink animation for escalation notifications
  - [ ] Style escalation notifications distinctly from regular conversation notifications
  - [ ] Ensure seamless integration with existing HeaderMenu.razor layout

## Dev Notes

### Previous Story Insights
From Story 4.14 implementation:
- Complete escalation notification system already exists with EscalationPopup.razor component [Source: src/Server.UI/Components/Conversations/EscalationPopup.razor]
- SignalR hub has comprehensive escalation broadcasting via `BroadcastConversationEscalated()` method [Source: src/Server.UI/Hubs/ServerHub.cs]
- Agent notification preferences system implemented with full CRUD operations [Source: 4.14.chat-escalation-agent-notification.md]
- Real-time notification delivery using SignalR already functional [Source: 4.14.chat-escalation-agent-notification.md]

### Existing Foundation Analysis

**Current Escalation Flow**:
- EscalationPopup.razor handles escalation display with Accept/Decline/Ignore actions [Source: src/Server.UI/Components/Conversations/EscalationPopup.razor:58-78]
- `IgnoreEscalation()` method currently calls `HidePopup()` and invokes callback, effectively dismissing the escalation [Source: src/Server.UI/Components/Conversations/EscalationPopup.razor:237-247]
- `AcceptEscalation()` method properly handles escalation acceptance and navigation [Source: src/Server.UI/Components/Conversations/EscalationPopup.razor:186-223]

**Current Notification System**:
- NotificationIndicator.razor in HeaderMenu provides comprehensive notification management [Source: src/Server.UI/Components/Shared/Layout/NotificationIndicator.razor]
- Blinking animation system already implemented with `StartBlinking()` and `StopBlinking()` methods [Source: src/Server.UI/Components/Shared/Layout/NotificationIndicator.razor:602-625]
- Badge count display and notification grouping functionality exists [Source: src/Server.UI/Components/Shared/Layout/NotificationIndicator.razor:17-27]
- SignalR integration with conversation assignment and message tracking [Source: src/Server.UI/Components/Shared/Layout/NotificationIndicator.razor:258-270]

**Gap Identified**:
- **Current Issue**: When agent clicks "Ignore" on escalation popup, the escalation disappears completely and no persistent reminder exists
- **Required Enhancement**: Escalation should remain in notification system until someone accepts it, not just until individual agent ignores it

### Data Models

**Existing Models (No Changes Required)**:
- **EscalationPopupDto**: Contains all necessary escalation context (customer info, reason, priority, timing) [Source: src/Server.UI/Components/Conversations/EscalationPopup.razor:112]
- **ConversationDto**: Has escalation status and assignment tracking [Source: Story 4.14 analysis]
- **AgentNotificationPreferences**: Preference system for notification filtering [Source: Story 4.14 implementation]

**Required Model Extensions**:
- **NotificationItem**: Extend existing class to include escalation-specific fields [Source: src/Server.UI/Components/Shared/Layout/NotificationIndicator.razor:135-143]
  - Add `IsEscalation` boolean property
  - Add `EscalationData` property to store EscalationPopupDto context
  - Add `IgnoredByAgents` collection to track who ignored vs accepted

### API Specifications

**Existing SignalR Hub Methods (To Enhance)**:
- **BroadcastConversationEscalated**: Currently broadcasts escalation popup, enhance to also create persistent notifications [Source: src/Server.UI/Hubs/ServerHub.cs]
- **ConversationAssigned**: Modify to clear escalation notifications when someone accepts [Source: NotificationIndicator.razor:296]

**New SignalR Hub Methods Required**:
- **BroadcastEscalationIgnored(string conversationId, string agentId)**: Broadcast when agent ignores escalation popup
- **BroadcastEscalationPersistentNotification(EscalationPopupDto escalationData)**: Create persistent notification for all agents
- **ClearEscalationNotification(string conversationId)**: Clear escalation notification when accepted

### Component Specifications

**EscalationPopup.razor Enhancement**:
Current ignore method:
```csharp
private async Task IgnoreEscalation()
{
    if (_escalationData == null) return;
    
    // Invoke the callback if it's set
    if (OnEscalationIgnored.HasDelegate)
    {
        await OnEscalationIgnored.InvokeAsync(_escalationData.ConversationReference);
    }
    HidePopup();
}
```
[Source: src/Server.UI/Components/Conversations/EscalationPopup.razor:237-247]

**Required Enhancement**:
- Add SignalR hub call to broadcast escalation ignored event
- Create persistent notification for all agents when individual ignores
- Maintain escalation context for persistent tracking

**NotificationIndicator.razor Enhancement**:
Current notification structure supports the required functionality:
- Badge system with count display [Source: src/Server.UI/Components/Shared/Layout/NotificationIndicator.razor:17-27]
- Blinking animation system [Source: src/Server.UI/Components/Shared/Layout/NotificationIndicator.razor:870-882]
- Dropdown menu with action buttons [Source: src/Server.UI/Components/Shared/Layout/NotificationIndicator.razor:59-105]

**Required Enhancement**:
- Add escalation notification tracking separate from conversation notifications
- Create escalation-specific menu items with Accept action
- Integrate escalation count with existing badge system

### File Locations

**Files to Modify**:
- `src/Server.UI/Components/Conversations/EscalationPopup.razor` - Enhance ignore behavior for persistence [Source: src/Server.UI/Components/Conversations/EscalationPopup.razor]
- `src/Server.UI/Components/Shared/Layout/NotificationIndicator.razor` - Add escalation notification tracking [Source: src/Server.UI/Components/Shared/Layout/NotificationIndicator.razor]
- `src/Server.UI/Hubs/ServerHub.cs` - Add escalation persistence SignalR methods [Source: src/Server.UI/Hubs/ServerHub.cs]
- `src/Server.UI/Hubs/ISignalRHub.cs` - Add interface methods for escalation persistence [Source: src/Server.UI/Hubs/ISignalRHub.cs]

**Files to Potentially Create**:
- None required - all functionality can be implemented by enhancing existing components

### SignalR Integration Architecture

**Current SignalR Flow**:
1. Escalation occurs → `BroadcastConversationEscalated()` → EscalationPopup shows to agents
2. Agent clicks Accept → `AcceptEscalation()` → Navigation to conversation 
3. Agent clicks Ignore → `IgnoreEscalation()` → Popup disappears (ISSUE: No persistence)

**Enhanced SignalR Flow**:
1. Escalation occurs → `BroadcastConversationEscalated()` → **BOTH** popup shows AND persistent notification created
2. Agent clicks Ignore → `IgnoreEscalation()` → Popup disappears BUT notification persists
3. Agent clicks Accept (from popup OR notification) → Clears notification for ALL agents
4. Real-time synchronization ensures all agents see same notification state

### Technical Constraints

**Database Access Pattern (CRITICAL)**:
- Use existing notification tracking in NotificationIndicator component - no database changes required [Source: docs/architecture/coding-standards.md#database-access-pattern]
- Leverage existing SignalR group management for real-time updates [Source: src/Server.UI/Components/Shared/Layout/NotificationIndicator.razor:637-682]

**Multi-Tenant Isolation (CRITICAL)**:
- Ensure escalation notifications respect tenant boundaries using existing agent group management [Source: docs/architecture/coding-standards.md#tenant-isolation]
- Use existing tenant-aware SignalR connection groups [Source: NotificationIndicator.razor analysis]

**Real-Time Performance Requirements**:
- Leverage existing SignalR connection management and group membership [Source: src/Server.UI/Components/Shared/Layout/NotificationIndicator.razor:233-294]
- Use existing notification deduplication and count management [Source: src/Server.UI/Components/Shared/Layout/NotificationIndicator.razor:747-771]

### Architecture Alignment

**Clean Architecture Compliance**:
- UI layer enhancements only - no business logic changes required [Source: docs/architecture/frontend-architecture.md]
- Leverage existing MediatR command patterns for escalation acceptance [Source: src/Server.UI/Components/Conversations/EscalationPopup.razor:195]
- Use existing SignalR hub infrastructure without domain changes [Source: docs/architecture/frontend-architecture.md]

**MudBlazor Integration**:
- Enhance existing MudBadge component with escalation count [Source: src/Server.UI/Components/Shared/Layout/NotificationIndicator.razor:17-27]
- Use existing MudMenu structure for escalation notification display [Source: src/Server.UI/Components/Shared/Layout/NotificationIndicator.razor:14-28]
- Leverage existing MudButton actions for Accept escalation functionality [Source: src/Server.UI/Components/Shared/Layout/NotificationIndicator.razor:48-55]

## Testing

### Test File Locations

**Component Tests**:
- `tests/Server.UI.Tests/Components/Conversations/EscalationPopupTests.cs` - Test enhanced ignore behavior
- `tests/Server.UI.Tests/Components/Layout/NotificationIndicatorTests.cs` - Test escalation notification persistence
- `tests/Server.UI.Tests/Hubs/EscalationNotificationPersistenceTests.cs` - Test SignalR escalation broadcasting

**Integration Tests**:
- `tests/Server.UI.IntegrationTests/Hubs/EscalationPersistenceFlowTests.cs` - End-to-end escalation notification flow

### Testing Standards

**Frontend Testing Framework**:
- Use bUnit for Blazor component testing with SignalR mocking [Source: docs/architecture/tech-stack.md#frontend-testing]
- Test escalation notification persistence across multiple agent scenarios
- Mock EscalationPopup interactions and verify NotificationIndicator state changes

**SignalR Testing Patterns**:
- Mock SignalR hub connections for component tests [Source: docs/architecture/testing-strategy.md]
- Test real-time notification synchronization between multiple connected agents
- Verify escalation state management during ignore/accept scenarios

**Testing Requirements**:
- Test that ignored escalations remain in notification system for all agents
- Test that accepted escalations clear notifications for all agents immediately
- Test notification count accuracy with multiple concurrent escalations
- Test integration between EscalationPopup ignore behavior and NotificationIndicator persistence
- Test real-time synchronization of escalation notification state

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-08 | 1.0 | Initial story creation for persistent escalation notification icon enhancement | Bob (Scrum Master) |