# Story 4.6: Agent Escalation Popup & Conversation Interface

## Status
**Approved**

## Story
**As a** support agent,  
**I want** to receive floating popup notifications for chat escalations with direct accept/decline actions and enhanced messaging capability on the existing conversation interface,  
**so that** I can respond to escalations immediately from anywhere in the system and continue conversations with customers using the existing conversation view.

## Acceptance Criteria
1. System-wide floating popup dialog that appears to ALL logged-in available agents with capacity when chat escalations occur, regardless of current page location
2. Popup displays escalation summary with customer information, escalation reason, and conversation context
3. Each agent can independently accept, decline, or ignore the popup notification
4. First agent to accept gets the escalation, popup automatically closes for all other agents
5. Upon accepting escalation, agent is automatically navigated to existing conversation detail page (`/agent/conversations/{id}`)
6. Enhance existing conversation detail page with message input capability for agent replies
7. Agent can send messages directly to customer through WhatsApp integration continuing the conversation
8. Real-time message synchronization between agent interface and customer WhatsApp with live message updates
9. Integration with existing handoff tracking system to properly record agent takeover

## Tasks / Subtasks

- [ ] **Create System-Wide Escalation Popup Component** (AC: 1, 2, 3, 4)
  - [ ] Create `EscalationPopupService.razor` as global overlay component
  - [ ] Implement floating dialog with Material Design styling using MudDialog
  - [ ] Add popup positioning and z-index management for system-wide display
  - [ ] Create escalation summary display with customer info, reason, and context
  - [ ] Add Accept/Decline/Ignore action buttons with proper state management
  - [ ] Implement multi-agent popup broadcasting to all available agents with capacity
  - [ ] Add first-agent-wins logic with automatic popup dismissal for other agents
  - [ ] Add popup timeout and auto-dismiss functionality based on agent preferences

- [ ] **Enhance SignalR Multi-Agent Popup Integration** (AC: 1, 4)
  - [ ] Modify `ServerHub.cs` to broadcast escalation popups to all available agents with capacity
  - [ ] Add agent capacity checking logic based on `MaxConcurrentConversations` and current workload
  - [ ] Add new hub method `BroadcastEscalationPopupToAvailableAgents` with rich conversation data
  - [ ] Create hub method `NotifyEscalationAccepted` to dismiss popups for other agents
  - [ ] Update `ISignalRHub.cs` interface with multi-agent popup notification methods
  - [ ] Create popup service registration and global component integration

- [ ] **Enhance Existing Conversation Detail Page** (AC: 5, 6, 7, 8, 9)
  - [ ] Modify existing `src/Server.UI/Pages/Agent/ConversationDetail.razor` to add message input capability
  - [ ] Create `MessageInputComponent.razor` for agent message composition and sending
  - [ ] Add real-time message updates to existing conversation display using SignalR
  - [ ] Integrate message sending with Bot service WhatsApp endpoint
  - [ ] Add conversation status indicators for active agent engagement
  - [ ] Implement auto-refresh of message display when new messages arrive

- [ ] **Implement Message Sending Data Layer** (AC: 6, 7, 8)
  - [ ] Create `SendAgentMessageCommand` and handler for WhatsApp message sending
  - [ ] Enhance existing `ConversationMessageDto` to support agent message types
  - [ ] Create conversation state management commands (accept escalation, mark agent active)
  - [ ] Integrate with existing `Conversation` entity and `ConversationHandoff` tracking

- [ ] **Add Multi-Agent Navigation and State Management** (AC: 4, 5)
  - [ ] Create popup navigation service for direct routing to existing conversation page
  - [ ] Implement first-agent-wins escalation acceptance with automatic assignment
  - [ ] Add escalation acceptance state management and handoff recording
  - [ ] Create logic to dismiss popups for all other agents when one agent accepts
  - [ ] Integrate with existing conversation loading and display logic

- [ ] **Integrate with Existing Bot Service** (AC: 7, 8, 9)
  - [ ] Add agent message endpoint to Bot service for WhatsApp message sending
  - [ ] Create handoff indicator system in conversation display
  - [ ] Update Bot service to handle agent message routing
  - [ ] Add conversation ownership transfer from bot to agent

- [ ] **Add Testing Coverage** (All ACs)
  - [ ] Create unit tests for multi-agent popup service and conversation components
  - [ ] Create integration tests for SignalR multi-agent popup broadcasting
  - [ ] Test first-agent-wins logic and popup dismissal for other agents
  - [ ] Create component tests for enhanced conversation interface functionality
  - [ ] Add end-to-end tests for complete multi-agent escalation acceptance workflow

## Dev Notes

### Previous Story Insights
From Story 4.5 implementation:
- **SignalR Infrastructure**: Complete agent notification system with `TargetedEscalationNotification` and preference-based filtering [Source: docs/stories/4.5.chat-escalation-agent-notification.md]
- **Agent Dashboard Foundation**: Working agent dashboard with escalation queue and status management [Source: src/Server.UI/Pages/Conversations/AgentDashboard.razor]
- **Notification Preferences**: Complete agent preference system with browser/audio alerts and priority filtering [Source: src/Server.UI/Components/Agent/NotificationPreferencesComponent.razor]
- **Browser/Audio Notifications**: JavaScript notification system with priority-based alerts [Source: src/Server.UI/wwwroot/js/notifications.js]

### Existing Conversation Interface Discovery
From codebase analysis:
- **Complete Conversation Detail Page**: Fully implemented at `src/Server.UI/Pages/Agent/ConversationDetail.razor` with route `/agent/conversations/{ConversationId}` [Source: src/Server.UI/Pages/Agent/ConversationDetail.razor]
- **Rich Message Display**: Existing UI with message threading, avatars, role indicators, and proper styling [Source: src/Server.UI/Pages/Agent/ConversationDetail.razor:200-255]
- **Handoff History Visualization**: Timeline component showing bot-to-human transitions and handoff status [Source: src/Server.UI/Pages/Agent/ConversationDetail.razor:260-310]
- **Conversation Metadata**: Complete participant tracking, duration, message counts, and summary display [Source: src/Server.UI/Pages/Agent/ConversationDetail.razor:80-185]
- **Working Query Integration**: Uses `GetConversationByIdQuery` with `ConversationDetailsDto` for data loading [Source: src/Server.UI/Pages/Agent/ConversationDetail.razor:441-442]

### Data Models

**Conversation Entity** (Existing - Enhanced Usage):
- **Conversation.ConversationId**: Bot Framework identifier for WhatsApp conversation [Source: docs/architecture/data-models.md]
- **Conversation.Status**: ConversationStatus enum (Active, Escalated, Completed, Abandoned) [Source: docs/architecture/data-models.md]
- **Conversation.Mode**: ConversationMode enum (Bot, Human, Escalating) [Source: docs/architecture/data-models.md]
- **Conversation.CurrentAgentId**: Currently assigned agent [Source: docs/architecture/data-models.md]
- **Conversation.EscalatedAt**: Timestamp when escalated to human [Source: docs/architecture/data-models.md]
- **Conversation.EscalationReason**: Reason for bot-to-human handoff [Source: docs/architecture/data-models.md]
- **Conversation.Priority**: Priority level (1=Standard, 2=High, 3=Critical) from Story 4.5 [Source: docs/stories/4.5.chat-escalation-agent-notification.md]

**ConversationHandoff Entity** (Existing):
- **ConversationHandoff.ConversationTranscript**: JSON conversation history [Source: docs/architecture/data-models.md]
- **ConversationHandoff.HandoffType**: HandoffType enum (BotToHuman, HumanToHuman, HumanToBot) [Source: docs/architecture/data-models.md]
- **ConversationHandoff.Status**: HandoffStatus enum (Initiated, Accepted, Completed, Failed) [Source: docs/architecture/data-models.md]
- **ConversationHandoff.FromAgentId** / **ToAgentId**: Agent handoff tracking [Source: docs/architecture/data-models.md]

**Existing DTOs to Leverage**:
- **ConversationDetailsDto**: Already contains Messages, Participants, HandoffHistory collections [Source: src/Server.UI/Pages/Agent/ConversationDetail.razor:429]
- **ConversationMessageDto**: Existing with Role, Content, Timestamp, UserName properties [Source: src/Server.UI/Pages/Agent/ConversationDetail.razor:203]

**New DTOs Required**:
- **EscalationPopupDto**: Popup display data with conversation summary, customer info, urgency level
- **AgentMessageDto**: For new agent message sending with WhatsApp integration

### API Specifications

**Existing CQRS Queries to Leverage**:
- **GetConversationByIdQuery**: Already implemented for conversation detail display [Source: src/Server.UI/Pages/Agent/ConversationDetail.razor:441]

**New CQRS Query Patterns**:
- **GetConversationContextQuery**: Inherits from `ICacheableRequest<Result<EscalationPopupDto>>` for popup summary [Source: docs/architecture/coding-standards.md]

**New CQRS Command Patterns**:
- **SendAgentMessageCommand**: Inherits from `ICacheInvalidatorRequest<Result<Unit>>` for WhatsApp message sending [Source: docs/architecture/coding-standards.md]
- **AcceptEscalationCommand**: Inherits from `ICacheInvalidatorRequest<Result<ConversationDto>>` for escalation acceptance [Source: docs/architecture/coding-standards.md]
- **CompleteConversationHandoffCommand**: Inherits from `ICacheInvalidatorRequest<Result<Unit>>` for handoff completion [Source: docs/architecture/coding-standards.md]

**Enhanced SignalR Hub Methods**:
- **BroadcastEscalationPopupToAvailableAgents(EscalationPopupDto popup)**: Multi-agent popup delivery to all available agents with capacity
- **NotifyEscalationAccepted(int conversationId, string acceptingAgentId)**: Dismiss popups for all other agents when one accepts
- **BroadcastAgentMessageSent(int conversationId, ConversationMessageDto message)**: Real-time message updates
- **BroadcastConversationHandoffCompleted(int conversationId, string fromAgent, string toAgent)**: Handoff completion notifications

### File Locations

**Files to Create**:
- `src/Server.UI/Components/Conversations/EscalationPopupService.razor` - Global popup overlay component [Source: docs/architecture/unified-project-structure.md#components]
- `src/Server.UI/Components/Conversations/EscalationPopup.razor` - Popup dialog component [Source: docs/architecture/unified-project-structure.md#components]
- `src/Server.UI/Components/Conversations/MessageInputComponent.razor` - Agent message input component [Source: docs/architecture/unified-project-structure.md#components]
- `src/Application/Features/Conversations/Queries/GetConversationContext/GetConversationContextQuery.cs` - Popup context query [Source: docs/architecture/unified-project-structure.md#cqrs-handlers]
- `src/Application/Features/Conversations/Queries/GetConversationContext/GetConversationContextQueryHandler.cs` - Context query handler
- `src/Application/Features/Conversations/Commands/SendAgentMessage/SendAgentMessageCommand.cs` - Agent message command [Source: docs/architecture/unified-project-structure.md#cqrs-handlers]
- `src/Application/Features/Conversations/Commands/SendAgentMessage/SendAgentMessageCommandHandler.cs` - Message sending handler
- `src/Application/Features/Conversations/Commands/AcceptEscalation/AcceptEscalationCommand.cs` - Escalation acceptance command
- `src/Application/Features/Conversations/Commands/AcceptEscalation/AcceptEscalationCommandHandler.cs` - Acceptance handler
- `src/Application/Features/Conversations/DTOs/EscalationPopupDto.cs` - Popup data DTO
- `src/Application/Features/Conversations/DTOs/AgentMessageDto.cs` - Agent message DTO
- `src/Server.UI/Services/EscalationPopupService.cs` - Navigation service for popup-to-conversation routing [Source: docs/architecture/unified-project-structure.md#services]

**Files to Modify**:
- `src/Server.UI/Pages/Agent/ConversationDetail.razor` - Add message input component and real-time message updates [Source: src/Server.UI/Pages/Agent/ConversationDetail.razor]
- `src/Server.UI/Hubs/ServerHub.cs` - Add popup delivery and conversation message broadcasting [Source: src/Server.UI/Hubs/ServerHub.cs]
- `src/Server.UI/Hubs/ISignalRHub.cs` - Add popup and conversation interface methods [Source: src/Server.UI/Hubs/ISignalRHub.cs]
- `src/Server.UI/App.razor` or `MainLayout.razor` - Add global popup service component
- `src/Bot/Controllers/BotController.cs` - Add agent message endpoint for WhatsApp sending [Source: docs/architecture/unified-project-structure.md#bot-service]

### Component Specifications

**Escalation Popup Component Template**:
```razor
@inject IMediator Mediator
@inject IJSRuntime JS
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@implements IAsyncDisposable

<MudOverlay Visible="@_showPopup" DarkBackground="true" ZIndex="9999">
    <MudPaper Class="escalation-popup pa-6" Style="max-width: 500px; margin: auto;">
        <MudText Typo="Typo.h6" Class="mb-4">
            <MudIcon Icon="@Icons.Material.Filled.SupportAgent" Class="mr-2"/>
            Chat Escalation
        </MudText>
        
        @if (_escalationData != null)
        {
            <MudGrid>
                <MudItem xs="12">
                    <MudText Typo="Typo.subtitle2">Customer: @_escalationData.CustomerName</MudText>
                    <MudText Typo="Typo.body2">Phone: @_escalationData.PhoneNumber</MudText>
                </MudItem>
                <MudItem xs="12">
                    <MudText Typo="Typo.subtitle2">Reason:</MudText>
                    <MudText Typo="Typo.body2">@_escalationData.EscalationReason</MudText>
                </MudItem>
            </MudGrid>
        }
        
        <MudCardActions Class="justify-end mt-4">
            <MudButton OnClick="IgnoreEscalation" Variant="Variant.Text">
                Ignore
            </MudButton>
            <MudButton OnClick="DeclineEscalation" Variant="Variant.Outlined" Color="Color.Warning">
                Decline
            </MudButton>
            <MudButton OnClick="AcceptEscalation" Variant="Variant.Filled" Color="Color.Primary">
                Accept & View Conversation
            </MudButton>
        </MudCardActions>
    </MudPaper>
</MudOverlay>
```
[Source: docs/architecture/frontend-architecture.md#component-template]

**Enhanced Existing Conversation Page Integration**:
The existing `ConversationDetail.razor` page will be enhanced by adding the `MessageInputComponent` at the bottom of the message display area:

```razor
<!-- Add to existing ConversationDetail.razor after message display -->
<MudCardContent Style="border-top: 1px solid var(--mud-palette-lines-default); padding: 16px;">
    <MessageInputComponent ConversationId="@ConversationId" 
                         OnMessageSent="HandleNewMessage" 
                         Disabled="@_sendingMessage" />
</MudCardContent>
```

This preserves all existing functionality while adding agent messaging capability.
[Source: src/Server.UI/Pages/Agent/ConversationDetail.razor]

### Technical Constraints

**Database Access Pattern (CRITICAL)**:
- **ALWAYS use `IApplicationDbContextFactory` for database access** [Source: docs/architecture/coding-standards.md#database-access-pattern]
- Use `await using var db = await _dbContextFactory.CreateAsync(ct);` pattern [Source: docs/architecture/coding-standards.md#database-access-pattern]
- Use efficient `.Include()` statements for Conversation, ConversationHandoff, and Agent relationships [Source: docs/architecture/coding-standards.md#database-access-pattern]

**Multi-Tenant Isolation (CRITICAL)**:
- All queries must include tenant filtering for Conversation and Agent entities [Source: docs/architecture/coding-standards.md#tenant-isolation]
- Use current user's tenant context for conversation access validation [Source: docs/architecture/coding-standards.md#tenant-isolation]
- Ensure popup notifications only reach agents within the same tenant [Source: docs/architecture/coding-standards.md#tenant-isolation]

**Real-Time Performance Requirements**:
- Popup notifications must be delivered to ALL available agents within 500ms of escalation trigger [Source: docs/stories/4.5.chat-escalation-agent-notification.md]
- Popup dismissal for other agents must occur within 1 second of acceptance by first agent
- Message synchronization between agent interface and WhatsApp must be under 2 seconds
- Conversation history loading must complete within 3 seconds for good UX
- Global popup overlay must not interfere with existing page functionality

**Multi-Agent Coordination Requirements**:
- Agent capacity checking must consider current `ActiveConversationCount` vs `MaxConcurrentConversations`
- Only logged-in agents with available status (Available, not Busy/Break/Offline) should receive popups
- First-agent-wins logic must prevent duplicate conversation assignments
- Popup state synchronization across all agent sessions must be reliable

**Bot Service Integration Requirements**:
- Agent messages must route through Bot service to maintain conversation context
- WhatsApp message format must match existing bot message structure
- Handoff status must be properly communicated to bot for conversation state management
- Message threading must maintain conversation continuity

### Permission System Integration

**New Permissions Required**:
- `Permissions.Conversations.HandleEscalations` - Access conversation interface and accept escalations
- `Permissions.Conversations.SendMessages` - Send messages to customers via agent interface
- `Permissions.Conversations.ViewHistory` - View complete conversation history

**Permission Checks**:
- Use `[Authorize(Policy = Permissions.Conversations.HandleEscalations)]` on conversation page [Source: docs/architecture/coding-standards.md#permission-checks]
- Use `[MustHavePermission(Permissions.Conversations.SendMessages)]` for message sending commands [Source: docs/architecture/coding-standards.md#permission-checks]
- Check permissions in popup component with `IPermissionService.HasPermissionAsync` [Source: docs/architecture/coding-standards.md#permission-checks]

### Architecture Alignment

**Clean Architecture Compliance**:
- UI layer communicates with Application layer via MediatR for all conversation operations [Source: docs/architecture/frontend-architecture.md]
- Domain entities contain business logic for conversation state transitions and handoff validation [Source: docs/architecture/backend-architecture.md]
- Infrastructure handles SignalR broadcasting and external WhatsApp service integration [Source: docs/architecture/frontend-architecture.md]

**Bot Framework Integration**:
- Maintain conversation context continuity between bot and agent messages [Source: docs/architecture/components.md#bot-service-component]
- Preserve WhatsApp conversation threading for seamless customer experience [Source: docs/architecture/components.md#bot-service-component]
- Proper handoff status management for bot-to-human transition [Source: docs/architecture/components.md#bot-service-component]

**SignalR Hub Architecture**:
- Build on existing agent group management from Story 4.5 [Source: docs/stories/4.5.chat-escalation-agent-notification.md]
- Use targeted notifications with preference filtering [Source: docs/stories/4.5.chat-escalation-agent-notification.md]
- Maintain connection state management and graceful reconnection [Source: docs/stories/4.5.chat-escalation-agent-notification.md]

## Testing

### Test File Locations

**Component Tests**:
- `tests/Server.UI.Tests/Components/Conversations/EscalationPopupTests.cs` - Popup component tests [Source: docs/architecture/testing-strategy.md#test-organization]
- `tests/Server.UI.Tests/Pages/Agent/ConversationDetailTests.cs` - Enhanced conversation page tests [Source: docs/architecture/testing-strategy.md#test-organization]
- `tests/Server.UI.Tests/Components/Conversations/MessageInputComponentTests.cs` - Message input component tests [Source: docs/architecture/testing-strategy.md#test-organization]

**Command Handler Tests**:
- `tests/Application.UnitTests/Features/Conversations/Commands/SendAgentMessageCommandHandlerTests.cs` - Message sending tests [Source: docs/architecture/testing-strategy.md#test-organization]
- `tests/Application.UnitTests/Features/Conversations/Commands/AcceptEscalationCommandHandlerTests.cs` - Escalation acceptance tests [Source: docs/architecture/testing-strategy.md#test-organization]

**Query Handler Tests**:
- `tests/Application.UnitTests/Features/Conversations/Queries/GetConversationContextQueryHandlerTests.cs` - Popup context retrieval tests [Source: docs/architecture/testing-strategy.md#test-organization]

**SignalR Integration Tests**:
- `tests/Server.UI.IntegrationTests/Hubs/EscalationPopupDeliveryTests.cs` - Popup notification tests [Source: docs/architecture/testing-strategy.md#test-organization]
- `tests/Server.UI.IntegrationTests/Hubs/ConversationMessageBroadcastTests.cs` - Message broadcasting tests [Source: docs/architecture/testing-strategy.md#test-organization]

**End-to-End Tests**:
- `tests/Server.UI.IntegrationTests/Workflows/EscalationAcceptanceWorkflowTests.cs` - Complete escalation flow tests [Source: docs/architecture/testing-strategy.md#test-organization]

### Testing Standards

**Frontend Testing Framework**:
- Use bUnit for Blazor component testing with SignalR mocking [Source: docs/architecture/tech-stack.md#frontend-testing]
- Test popup overlay functionality, message display, and navigation [Source: docs/architecture/testing-strategy.md#test-organization]
- Mock SignalR hub connections and verify popup delivery [Source: docs/architecture/testing-strategy.md#test-organization]

**Backend Testing Framework**:
- Use xUnit + FluentAssertions for command/query handler tests [Source: docs/architecture/tech-stack.md#backend-testing]
- Mock `IApplicationDbContextFactory` and Bot service integration in unit tests [Source: docs/architecture/testing-strategy.md]
- Use TestBase class for integration tests with database and SignalR setup [Source: docs/architecture/testing-strategy.md]

**Testing Requirements**:
- Test tenant isolation for all conversation and agent operations [Source: docs/architecture/coding-standards.md#tenant-isolation]
- Test multi-agent popup delivery to all available agents with capacity [Source: docs/stories/4.5.chat-escalation-agent-notification.md]
- Test first-agent-wins logic and automatic popup dismissal for other agents
- Test agent capacity checking based on workload and availability status
- Test conversation message synchronization between agent interface and WhatsApp
- Test escalation acceptance workflow with proper navigation to existing conversation page
- Test permission-based access control for conversation operations
- Test integration with existing Bot service for message sending and handoff management
- Test real-time message updates in existing conversation display
- Test popup timeout, dismissal, and multi-agent coordination scenarios
- Test enhancement of existing conversation page without breaking current functionality

**Domain Testing**:
- Test Conversation entity state transitions for escalation acceptance and completion
- Test ConversationHandoff entity handoff status progression and timing
- Test message ordering and conversation continuity validation
- Test domain event generation for audit trails and notification triggers

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-06 | 1.0 | Initial story creation with comprehensive popup and conversation interface design | Bob (Scrum Master) |
| 2025-09-06 | 1.1 | Updated story scope to leverage existing ConversationDetail.razor page and focus on popup system + message input enhancement | Bob (Scrum Master) |
| 2025-09-06 | 1.2 | Enhanced story to specify multi-agent popup broadcasting with first-agent-wins logic and capacity checking | Bob (Scrum Master) |