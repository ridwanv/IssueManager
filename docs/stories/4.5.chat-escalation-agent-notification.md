# Story 4.5: Chat Escalation & Agent Notification System

## Status
**In Progress** - *Core real-time notification features implemented, remaining preference system*

## Story
**As a** support agent,  
**I want** to receive real-time SignalR notifications when new conversations are escalated so I can quickly respond to customer escalations,  
**so that** I don't need to constantly refresh the agent dashboard to see new escalated conversations.

## Acceptance Criteria
1. Real-time SignalR notifications to agents when new conversations are escalated (enhance existing `BroadcastConversationEscalated`)
2. Browser notifications for agents when they're not actively viewing the dashboard
3. Audio notification alerts for critical escalations
4. Auto-refresh enhancements to complement real-time updates (reduce current 30-second polling)
5. Notification preferences allowing agents to enable/disable different alert types
6. Escalation priority indicators for urgent conversations requiring immediate attention

## Tasks / Subtasks

- [x] **Enhance Real-Time SignalR Notifications** (AC: 1)
  - [x] Extend existing `AgentDashboard.razor` to connect to SignalR hub for live updates
  - [x] Enhance existing `BroadcastConversationEscalated` method with targeted agent notifications
  - [x] Add SignalR connection management to dashboard with automatic reconnection
  - [x] Replace current 30-second timer polling with event-driven updates
  
- [x] **Implement Browser & Audio Notifications** (AC: 2, 3)
  - [x] Add JavaScript integration for browser notification API
  - [x] Create audio notification system with configurable sound alerts
  - [x] Add notification permission request and handling
  - [x] Create escalation priority-based notification sounds
  
- [ ] **Create Agent Notification Preferences** (AC: 5)
  - [ ] Create `AgentNotificationPreferences` entity for user preferences
  - [ ] Create `UpdateAgentPreferencesCommand` and handler for preference management
  - [ ] Add preference UI to existing `AgentDashboard.razor` 
  - [ ] Implement notification filtering based on agent preferences
  
- [x] **Add Escalation Priority System** (AC: 6)
  - [x] Add `Priority` field to existing `Conversation` entity
  - [x] Enhance `GetEscalatedConversationsQuery` to include priority sorting
  - [x] Add priority indicators to existing dashboard UI cards
  - [x] Create priority-based notification routing (critical escalations get immediate alerts)
  
- [x] **Optimize Dashboard Performance** (AC: 4)
  - [x] Replace current auto-refresh timer with SignalR event listeners
  - [x] Add incremental updates instead of full data refresh
  - [x] Implement connection state management for offline/online scenarios
  - [x] Add loading state improvements and error handling
  
- [ ] **Add Testing Coverage** (All ACs)
  - [ ] Create unit tests for new SignalR notification methods
  - [ ] Create integration tests for browser notification functionality
  - [ ] Create component tests for enhanced dashboard real-time features
  - [ ] Add end-to-end tests for notification workflows

## Dev Notes

### Previous Story Insights
From Story 2.2 implementation:
- SignalR `ServerHub` has foundational agent group management with `JoinAgentGroup()` and `LeaveAgentGroup()` methods [Source: src/Server.UI/Hubs/ServerHub.cs]
- Existing conversation escalation broadcasting via `BroadcastConversationEscalated()` method [Source: src/Server.UI/Hubs/ServerHub.cs]
- Agent status change broadcasting with `BroadcastAgentStatusChanged()` method [Source: src/Server.UI/Hubs/ServerHub.cs]
- Conversation assignment handling via `AcceptConversation()` and `BroadcastConversationAssigned()` methods [Source: src/Server.UI/Hubs/ServerHub.cs]

### Existing Foundation - Major Discovery
From current codebase analysis:

**Complete Agent Dashboard Already Exists**:
- **Full agent dashboard** at `src/Server.UI/Pages/Conversations/AgentDashboard.razor` (`/agent-dashboard` route) [Source: src/Server.UI/Pages/Conversations/AgentDashboard.razor]
- **Available agents panel** with workload visualization and status indicators [Source: src/Server.UI/Pages/Conversations/AgentDashboard.razor:38-77]
- **Escalated conversations queue** with conversation details, Accept/Complete buttons [Source: src/Server.UI/Pages/Conversations/AgentDashboard.razor:80-184]
- **Auto-assign toggle** and 30-second auto-refresh timer already implemented [Source: src/Server.UI/Pages/Conversations/AgentDashboard.razor:88-91, 202]
- **Working CQRS commands**: `GetEscalatedConversationsQuery`, `GetAvailableAgentsQuery`, `AssignAgentCommand`, `CompleteConversationCommand` [Source: src/Server.UI/Pages/Conversations/AgentDashboard.razor:3-6]

**Existing Agent Management**:
- **Agent listing page** at `src/Server.UI/Pages/Agents/Agents.razor` with administrative status management [Source: src/Server.UI/Pages/Agents/Agents.razor]
- **Working UpdateAgentStatusCommand** with status updates [Source: src/Server.UI/Pages/Agents/Agents.razor:307]

**Current Limitations Identified**:
- **No real-time updates** - Dashboard uses 30-second polling instead of SignalR [Source: src/Server.UI/Pages/Conversations/AgentDashboard.razor:202]
- **No browser/audio notifications** - Agents must keep dashboard open to see new escalations
- **No notification preferences** - All agents get the same experience
- **No escalation priority system** - All escalations treated equally
- **TODO comments** indicating incomplete implementation [Source: src/Server.UI/Pages/Conversations/AgentDashboard.razor:244, 295]

### Data Models

**Agent Entity** (Existing):
- **Agent.Id**: GUID primary identifier [Source: src/Domain/Entities/Agent.cs]
- **Agent.ApplicationUserId**: Link to system user account [Source: src/Domain/Entities/Agent.cs]
- **Agent.Status**: AgentStatus enum (Offline, Available, Busy, Break) [Source: src/Domain/Entities/Agent.cs]
- **Agent.MaxConcurrentConversations**: Workload limit (default: 5) [Source: src/Domain/Entities/Agent.cs]
- **Agent.ActiveConversationCount**: Current conversation count [Source: src/Domain/Entities/Agent.cs]
- **Agent.LastActiveAt**: Timestamp for availability tracking [Source: src/Domain/Entities/Agent.cs]
- **Agent.Skills**: JSON array for specialized routing [Source: src/Domain/Entities/Agent.cs]
- **Agent.Priority**: Higher priority agents get assignments first [Source: src/Domain/Entities/Agent.cs]

**Conversation Entity** (Existing):
- **Conversation.ConversationId**: Bot Framework identifier [Source: src/Domain/Entities/Conversation.cs]
- **Conversation.Status**: ConversationStatus enum (Active, Escalated, Completed, Abandoned) [Source: src/Domain/Entities/Conversation.cs]
- **Conversation.Mode**: ConversationMode enum (Bot, Human, Escalating) [Source: src/Domain/Entities/Conversation.cs]
- **Conversation.CurrentAgentId**: Currently assigned agent [Source: src/Domain/Entities/Conversation.cs]
- **Conversation.EscalatedAt**: Timestamp when escalated to human [Source: src/Domain/Entities/Conversation.cs]
- **Conversation.EscalationReason**: Reason for bot-to-human handoff [Source: src/Domain/Entities/Conversation.cs]
- **Conversation.WhatsAppPhoneNumber**: Customer contact information [Source: src/Domain/Entities/Conversation.cs]

**ConversationHandoff Entity** (Existing):
- **ConversationHandoff.HandoffType**: HandoffType enum (BotToHuman, HumanToHuman, HumanToBot) [Source: src/Domain/Entities/ConversationHandoff.cs]
- **ConversationHandoff.Status**: HandoffStatus enum (Initiated, Accepted, Completed, Failed) [Source: src/Domain/Entities/ConversationHandoff.cs]
- **ConversationHandoff.FromAgentId** / **ToAgentId**: Agent handoff tracking [Source: src/Domain/Entities/ConversationHandoff.cs]
- **ConversationHandoff.ConversationTranscript**: JSON conversation history [Source: src/Domain/Entities/ConversationHandoff.cs]
- **ConversationHandoff.InitiatedAt** / **AcceptedAt** / **CompletedAt**: Timing tracking [Source: src/Domain/Entities/ConversationHandoff.cs]

### Contact Center Management System Research Insights

**Real-Time Notification Standards (2025)**:
- AI-powered escalation detection with sentiment analysis and frustration indicators [Source: Web Research]
- Automated escalation management with configurable rules based on conversation age, priority, and response times [Source: Web Research]
- Skills-based routing for agent assignment based on specialization and expertise [Source: Web Research]
- Omnichannel integration ensuring seamless transition between bot and human agents [Source: Web Research]
- Real-time supervisor assistance with alerts for high-stake conversations [Source: Web Research]

**Modern Agent Notification Patterns**:
- Push notifications to available agents with conversation context and customer history
- Queue prioritization based on customer tier, issue urgency, and wait time
- Predictive routing allocating conversations to best-suited agents
- Real-time workload balancing preventing agent overload
- Escalation reason categorization for proper skill matching

### API Specifications

**CQRS Command Patterns**:
- **UpdateAgentStatusCommand**: Inherits from `ICacheInvalidatorRequest<Result<Unit>>` with agent status validation [Source: docs/architecture/coding-standards.md#api-error-handling]
- **EscalateConversationCommand**: Inherits from `ICacheInvalidatorRequest<Result<ConversationHandoffDto>>` with reason tracking [Source: docs/architecture/coding-standards.md#api-error-handling]
- **AcceptConversationCommand**: Inherits from `ICacheInvalidatorRequest<Result<Unit>>` with availability validation [Source: docs/architecture/coding-standards.md#api-error-handling]
- **ReassignConversationCommand**: Inherits from `ICacheInvalidatorRequest<Result<Unit>>` for automatic reassignment [Source: docs/architecture/coding-standards.md#api-error-handling]

**CQRS Query Patterns**:
- **GetAgentsByStatusQuery**: Inherits from `ICacheableRequest<Result<List<AgentDto>>>` for agent availability lookup [Source: docs/architecture/coding-standards.md]
- **GetEscalationQueueQuery**: Inherits from `ICacheableRequest<Result<List<EscalatedConversationDto>>>` for queue management [Source: docs/architecture/coding-standards.md]
- **GetAgentDashboardQuery**: Inherits from `ICacheableRequest<Result<AgentDashboardDto>>` for dashboard data [Source: docs/architecture/coding-standards.md]

### File Locations

**Files to Create**:
- `src/Domain/Entities/AgentNotificationPreferences.cs` - Agent notification preference entity [Source: docs/architecture/unified-project-structure.md#domain-entities]
- `src/Application/Features/Agents/Commands/UpdateAgentPreferences/UpdateAgentPreferencesCommand.cs` - Notification preferences command [Source: docs/architecture/unified-project-structure.md#cqrs-handlers]
- `src/Application/Features/Agents/Commands/UpdateAgentPreferences/UpdateAgentPreferencesCommandHandler.cs` - Preferences handler
- `src/Application/Features/Agents/Queries/GetAgentPreferences/GetAgentPreferencesQuery.cs` - Get agent preferences query
- `src/Application/Features/Agents/Queries/GetAgentPreferences/GetAgentPreferencesQueryHandler.cs` - Preferences query handler
- `src/Application/Features/Agents/DTOs/AgentNotificationPreferencesDto.cs` - Preferences DTO
- `src/Infrastructure/Persistence/Configurations/AgentNotificationPreferencesConfiguration.cs` - EF configuration for preferences [Source: docs/architecture/unified-project-structure.md#ef-configurations]
- `src/Server.UI/Components/Agent/NotificationPreferencesComponent.razor` - Preferences management component [Source: docs/architecture/unified-project-structure.md#components]
- `src/Server.UI/wwwroot/js/notifications.js` - JavaScript for browser/audio notifications

**Files to Modify**:
- `src/Server.UI/Pages/Conversations/AgentDashboard.razor` - Add SignalR integration, browser notifications, priority indicators [Source: src/Server.UI/Pages/Conversations/AgentDashboard.razor]
- `src/Server.UI/Hubs/ServerHub.cs` - Enhance existing escalation methods with targeted notifications [Source: src/Server.UI/Hubs/ServerHub.cs]
- `src/Server.UI/Hubs/ISignalRHub.cs` - Add new notification interface methods [Source: src/Server.UI/Hubs/ISignalRHub.cs]
- `src/Domain/Entities/Conversation.cs` - Add Priority field for escalation prioritization [Source: src/Domain/Entities/Conversation.cs]
- `src/Application/Features/Conversations/Queries/GetEscalatedConversations/GetEscalatedConversationsQuery.cs` - Add priority sorting [Source: src/Server.UI/Pages/Conversations/AgentDashboard.razor:4]
- `src/Infrastructure/Persistence/ApplicationDbContext.cs` - Add AgentNotificationPreferences DbSet [Source: docs/architecture/coding-standards.md#database-access-pattern]

### Component Specifications

**Existing Agent Dashboard Enhancements**:
Current dashboard at `/agent-dashboard` will be enhanced with:
```razor
@page "/agent-dashboard"  
@attribute [Authorize(Policy = Permissions.Conversations.ViewAgentDashboard)]
// Existing injections + new additions:
@inject IJSRuntime JS
@implements IAsyncDisposable
```
[Source: src/Server.UI/Pages/Conversations/AgentDashboard.razor]

**Key Architecture Decision**:
- **Enhance existing `AgentDashboard.razor`** instead of creating new dashboard to maintain current user workflows
- **Add real-time SignalR** to replace 30-second polling timer
- **Integrate browser/audio notifications** for background awareness

**MudBlazor Integration Components**:
- Use `MudSelect<AgentStatus>` for status dropdown with color-coded indicators [Source: docs/architecture/tech-stack.md#ui-component-library]
- Use `MudDataGrid<EscalatedConversationDto>` for escalation queue display [Source: docs/architecture/tech-stack.md#ui-component-library]
- Use `MudBadge` for conversation count indicators and notification badges [Source: docs/architecture/tech-stack.md#ui-component-library]
- Use `MudTimeline` for conversation history and escalation timeline display [Source: docs/architecture/tech-stack.md#ui-component-library]
- Use `MudButton` with confirmation dialog for conversation acceptance [Source: docs/architecture/tech-stack.md#ui-component-library]

### SignalR Hub Methods

**New Hub Methods to Add**:
- `BroadcastEscalationNotification(int conversationId, EscalatedConversationDto conversation)` - Targeted notification to available agents
- `BroadcastAgentWorkloadUpdated(string agentId, int activeCount, int maxCount)` - Workload status updates
- `BroadcastQueueUpdated(List<EscalatedConversationDto> queue)` - Queue state changes
- `BroadcastConversationAccepted(int conversationId, string agentId, string agentName)` - Assignment confirmations
- `BroadcastAgentAvailabilityChanged(string agentId, AgentStatus status, bool isAvailable)` - Status change notifications

### Technical Constraints

**Database Access Pattern (CRITICAL)**:
- **ALWAYS use `IApplicationDbContextFactory` for database access** [Source: docs/architecture/coding-standards.md#database-access-pattern]
- Use `await using var db = await _dbContextFactory.CreateAsync(ct);` pattern [Source: docs/architecture/coding-standards.md#database-access-pattern]
- Use efficient `.Include()` statements for Agent, Conversation, and ConversationHandoff relationships [Source: docs/architecture/coding-standards.md#database-access-pattern]

**Multi-Tenant Isolation (CRITICAL)**:
- All queries must include tenant filtering for Agent, Conversation, and ConversationHandoff entities [Source: docs/architecture/coding-standards.md#tenant-isolation]
- Use current user's tenant context for agent assignment validation [Source: docs/architecture/coding-standards.md#tenant-isolation]
- Ensure escalation notifications only reach agents within the same tenant [Source: docs/architecture/coding-standards.md#tenant-isolation]

**Real-Time Performance Requirements**:
- SignalR escalation notifications must be delivered within 500ms of escalation trigger
- Agent status updates must propagate to all connected agents within 1 second
- Queue updates should use incremental updates rather than full queue replacement
- Connection group management for efficient agent targeting and reduced broadcast overhead

**Agent Workload Management**:
- Automatic status updates when agents reach `MaxConcurrentConversations` limit
- Conversation reassignment when agents become unavailable or disconnected
- Priority-based assignment with higher priority agents receiving conversations first
- Skills-based routing using Agent.Skills JSON field for specialized conversation types

### Permission System Integration

**New Permissions Required**:
- `Permissions.Agents.UpdateStatus` - Change agent availability status
- `Permissions.Conversations.Accept` - Accept escalated conversations
- `Permissions.Conversations.Reassign` - Reassign conversations between agents
- `Permissions.Agents.ViewDashboard` - Access agent dashboard and queue

**Permission Checks**:
- Use `[Authorize(Policy = Permissions.Agents.ViewDashboard)]` on agent dashboard page [Source: docs/architecture/coding-standards.md#permission-checks]
- Use `[MustHavePermission(Permissions.Conversations.Accept)]` for conversation acceptance commands [Source: docs/architecture/coding-standards.md#permission-checks]
- Check permissions in components with `IPermissionService.HasPermissionAsync` [Source: docs/architecture/coding-standards.md#permission-checks]

### Architecture Alignment

**Clean Architecture Compliance**:
- UI layer communicates with Application layer via MediatR for all agent and conversation operations [Source: docs/architecture/frontend-architecture.md]
- Domain entities contain business logic for agent availability validation and conversation assignment [Source: docs/architecture/backend-architecture.md#domain-entity-example]
- Infrastructure handles SignalR broadcasting and external service notifications [Source: docs/architecture/frontend-architecture.md]

**Bot Framework Integration**:
- Conversation escalation triggers must integrate with existing Bot service via API calls
- Bot-to-human handoff should preserve conversation context and message history
- Seamless transition ensuring customers don't experience conversation interruption

## Testing

### Test File Locations

**Command Handler Tests**:
- `tests/Application.UnitTests/Features/Agents/Commands/UpdateAgentStatusCommandHandlerTests.cs` - Agent status management tests [Source: docs/architecture/testing-strategy.md#test-organization]
- `tests/Application.UnitTests/Features/Conversations/Commands/EscalateConversationCommandHandlerTests.cs` - Escalation logic tests [Source: docs/architecture/testing-strategy.md#test-organization]
- `tests/Application.UnitTests/Features/Conversations/Commands/AcceptConversationCommandHandlerTests.cs` - Acceptance workflow tests [Source: docs/architecture/testing-strategy.md#test-organization]

**Query Handler Tests**:
- `tests/Application.UnitTests/Features/Agents/Queries/GetAgentsByStatusQueryHandlerTests.cs` - Agent availability tests [Source: docs/architecture/testing-strategy.md#test-organization]
- `tests/Application.UnitTests/Features/Conversations/Queries/GetEscalationQueueQueryHandlerTests.cs` - Queue management tests [Source: docs/architecture/testing-strategy.md#test-organization]

**SignalR Integration Tests**:
- `tests/Server.UI.IntegrationTests/Hubs/EscalationNotificationTests.cs` - Real-time notification tests [Source: docs/architecture/testing-strategy.md#test-organization]
- `tests/Server.UI.IntegrationTests/Hubs/AgentGroupManagementTests.cs` - Agent group functionality tests [Source: docs/architecture/testing-strategy.md#test-organization]

**Blazor Component Tests**:
- `tests/Server.UI.Tests/Pages/Agent/DashboardTests.cs` - Dashboard page tests [Source: docs/architecture/testing-strategy.md#test-organization]
- `tests/Server.UI.Tests/Components/Conversations/EscalationQueueComponentTests.cs` - Queue component tests [Source: docs/architecture/testing-strategy.md#test-organization]

### Testing Standards

**Frontend Testing Framework**:
- Use bUnit for Blazor component testing with SignalR mocking [Source: docs/architecture/tech-stack.md#frontend-testing]
- Test real-time updates, agent status changes, and queue interactions [Source: docs/architecture/testing-strategy.md#test-organization]
- Mock SignalR hub connections and verify notification delivery [Source: docs/architecture/testing-strategy.md#test-organization]

**Backend Testing Framework**:
- Use xUnit + FluentAssertions for command/query handler tests [Source: docs/architecture/tech-stack.md#backend-testing]
- Mock `IApplicationDbContextFactory` and SignalR hub context in unit tests [Source: docs/architecture/testing-strategy.md]
- Use TestBase class for integration tests with database and SignalR setup [Source: docs/architecture/testing-strategy.md]

**Testing Requirements**:
- Test tenant isolation for all conversation and agent operations [Source: docs/stories/2.2.story.md]
- Test conversation assignment conflict resolution when multiple agents accept simultaneously
- Test workload balancing and maximum concurrent conversation limits using existing agent properties
- Test SignalR connection management and enhanced escalation notifications
- Test escalation notification delivery and queue state consistency
- Test automatic reassignment when agents become unavailable using existing status system
- Test permission-based access control for conversation acceptance operations
- Test integration with existing agent status management commands

**Domain Testing**:
- Test Agent entity business logic for availability calculation and workload limits
- Test Conversation entity escalation state management and assignment validation
- Test ConversationHandoff entity timing and status progression
- Test domain event generation for audit trails and notification triggers

## Dev Agent Record

**Agent Model Used**: `claude-sonnet-4-20250514`
**Date Started**: 2025-09-05  
**Date Completed**: In Progress

### Debug Log References
- Enhanced SignalR Hub methods for real-time agent notifications
- Implemented browser and audio notification system with JavaScript integration
- Added conversation priority system with visual indicators
- Connected AgentDashboard to SignalR for real-time updates
- Replaced 30-second polling with event-driven architecture

### Completion Notes
**Completed Core Features**:
- ✅ Real-time SignalR notifications with automatic reconnection
- ✅ Browser notification API integration with permission handling
- ✅ Audio notification system with priority-based sounds
- ✅ Conversation priority system (1=Standard, 2=High, 3=Critical)
- ✅ Priority-based sorting and visual indicators in dashboard
- ✅ Connection state management and error handling
- ✅ Replaced timer-based polling with SignalR events

**Remaining Features**:
- AgentNotificationPreferences entity and UI
- Comprehensive test coverage
- Additional notification preference controls

### File List
*Generated and maintained by dev agent - no manual edits*

**New Files Created**:
- `src/Server.UI/wwwroot/js/notifications.js` - Browser and audio notification system
- Database migration for Conversation Priority field

**Modified Files**:
- `src/Server.UI/Hubs/ISignalRHub.cs` - Added enhanced notification methods
- `src/Server.UI/Hubs/ServerHub.cs` - Implemented targeted agent notifications
- `src/Server.UI/Pages/Conversations/AgentDashboard.razor` - SignalR integration, priority indicators
- `src/Domain/Entities/Conversation.cs` - Added Priority field
- `src/Application/Features/Conversations/DTOs/ConversationDto.cs` - Priority support
- `src/Application/Features/Conversations/Queries/GetEscalatedConversations/GetEscalatedConversationsQuery.cs` - Priority sorting

**Testing Files**:
- Testing files to be created for comprehensive coverage

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-05 | 1.0 | Initial story creation with comprehensive escalation and notification system design | Bob (Scrum Master) |
| 2025-09-05 | 1.1 | Updated story number to 4.5 to align with Epic 4: Advanced Workflow & Escalation | Bob (Scrum Master) |
| 2025-09-05 | 1.2 | Major scope revision after discovering existing AgentDashboard.razor - focused on notification enhancements | Bob (Scrum Master) |
| 2025-09-05 | 1.3 | Major implementation progress - Core SignalR notifications, priority system, and browser/audio alerts completed | James (Dev Agent) |