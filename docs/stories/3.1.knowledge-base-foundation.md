# Story 3.1: Azure-Native Dual Knowledge Base Foundation

## Status
**Draft**

## Story
**As a** support administrator and bot system,
**I want** to integrate Azure Language Studio Custom Question Answering with existing Azure AI Search PDF capabilities,
**so that** common issues can be automatically resolved using both managed Q&A services and intelligent document retrieval.

## Acceptance Criteria
1. **Azure Language Studio Integration**: Configure Custom Question Answering project with curated Q&A pairs using Language Studio web interface
2. **Azure AI Search Enhancement**: Extend existing PDF document search with improved categorization and result ranking
3. **Dual Search Bot Plugin**: Enhanced KnowledgeBasePlugin that queries both Azure Language Studio and Azure AI Search, prioritizing by confidence scores
4. **Multi-language Support**: Configure Language Studio project for English and Afrikaans with language-specific Q&A pairs
5. **Unified Analytics**: Track search patterns and effectiveness across both Azure services with consolidated reporting
6. **Seamless WhatsApp Integration**: Single search function that intelligently routes queries between managed Q&A and document search

## Tasks / Subtasks

- [ ] **Setup Azure Language Studio Custom Question Answering** (AC: 1, 4)
  - [ ] Create Custom Question Answering project in Azure Language Studio
  - [ ] Configure multi-language support for English and Afrikaans Q&A pairs
  - [ ] Set up initial Q&A pairs with categories matching existing issue types
  - [ ] Configure confidence thresholds and default responses for unmatched queries
  - [ ] Test and publish the Custom Question Answering knowledge base
  - [ ] Obtain API keys and endpoint configuration for bot integration

- [ ] **Implement Azure Language Service Integration in Bot Project** (AC: 1, 3, 6)
  - [ ] Add Azure AI Language NuGet package to Bot project (`Azure.AI.Language.QuestionAnswering`)
  - [ ] Create `IAzureLanguageService` interface in `src/Bot/Services/` for Custom Question Answering API calls
  - [ ] Implement `AzureLanguageService` in `src/Bot/Services/` with REST API client for Q&A queries
  - [ ] Add Language Studio configuration settings to `src/Bot/appsettings.json` (endpoint, key, project)
  - [ ] Register `IAzureLanguageService` in Bot project dependency injection (`Program.cs` or `Startup.cs`)
  - [ ] Implement multi-language query support with language detection/specification
  - [ ] Add error handling for API failures, rate limiting, and authentication issues

- [ ] **Enhance KnowledgeBasePlugin for Dual Azure Search** (AC: 3, 6)
  - [ ] Extend existing `KnowledgeBasePlugin` constructor to inject `IAzureLanguageService`
  - [ ] Add new `SearchKnowledge` function that queries both Azure services in the Bot project
  - [ ] Implement intelligent routing: Language Studio first, then AI Search fallback
  - [ ] Add confidence scoring and result ranking across both Azure services
  - [ ] Preserve existing `FindHR` function for direct PDF document search unchanged
  - [ ] Add comprehensive result formatting for both service types
  - [ ] Implement analytics logging by calling UI project API endpoint via HTTP

- [ ] **Create Analytics Tracking Infrastructure in Application Layer** (AC: 5)
  - [ ] Create `KnowledgeSearchAnalytics` entity in `src/Domain/Entities/` for tracking dual-source usage
  - [ ] Add EF Core configuration in `src/Infrastructure/Persistence/Configurations/`
  - [ ] Create `LogKnowledgeSearchCommand` in Application layer for analytics tracking
  - [ ] Create analytics CQRS queries for knowledge base performance reporting in Application layer
  - [ ] Implement database migrations for analytics tracking tables
  - [ ] Create API endpoint in UI project for Bot to log search analytics via HTTP

- [ ] **Build Knowledge Base Analytics Dashboard** (AC: 5)
  - [ ] Create `KnowledgeBaseAnalytics` page for consolidated reporting
  - [ ] Display usage statistics for both Azure Language Studio and AI Search
  - [ ] Show query patterns, success rates, and confidence score distributions
  - [ ] Add visualizations comparing effectiveness of structured Q&A vs document search
  - [ ] Implement filtering by date range, language, and category for detailed analysis

- [ ] **Configure Multi-language Support and Testing** (AC: 4)
  - [ ] Set up English and Afrikaans Q&A pairs in Language Studio
  - [ ] Implement language detection for incoming queries
  - [ ] Test multi-language functionality end-to-end through WhatsApp bot
  - [ ] Add language-specific confidence threshold configuration
  - [ ] Create comprehensive test cases for both languages and service fallbacks

## Dev Notes

### Previous Story Insights
From existing bot and knowledge management implementation:
- **Azure AI Search Integration**: KnowledgeBasePlugin already implements semantic search with vector embeddings [Source: src/Bot/Plugins/KnowledgeBasePlugin.cs]
- **PDF Document Search**: Existing implementation searches policy documents with semantic ranking and SAS URI generation
- **Semantic Kernel Architecture**: Bot uses function calling with plugin-based architecture for extensible AI capabilities
- Issue entities and CQRS patterns are fully established [Source: src/Domain/Entities/Issue.cs]
- Multi-tenant isolation patterns are implemented [Source: existing entity configurations]
- Bot infrastructure with conversation data and API client integration [Source: existing bot plugins]

### Existing Azure AI Search Architecture
The current `KnowledgeBasePlugin` provides:
- **Vector Search**: Using `VectorizableTextQuery` with embeddings for semantic matching
- **Semantic Search**: Configured with semantic configuration for enhanced relevance
- **Blob Storage Integration**: SAS URI generation for secure document access
- **PDF Processing**: Document indexing and retrieval from Azure Blob Storage
- **Search Result Formatting**: Structured results with titles, sections, links, and content

### Azure Language Studio Integration Architecture

**Azure Language Service (Custom Question Answering)**:
- **Managed Service**: No local database entities needed - managed entirely in Azure
- **Language Studio**: Web-based management interface for Q&A pair creation and testing
- **REST API**: Direct API integration for querying Q&A knowledge base
- **Multi-language**: Native support for English and Afrikaans Q&A pairs
- **Confidence Scoring**: Built-in confidence scores (0.0-1.0) for answer relevance
- **Active Learning**: Automatic improvement through user interaction feedback
- **Multi-turn Conversations**: Support for follow-up questions and context

**Local Analytics Tracking Entity**:
Only one new entity needed for consolidated analytics:

**New KnowledgeSearchAnalytics Entity**:
- **Id**: Guid primary identifier
- **SearchQuery**: string - Original user query
- **SearchSource**: SearchSource enum - LanguageStudio, AzureAISearch, or Both
- **LanguageStudioResponse**: string? - JSON response from Language Studio (if used)
- **AzureSearchResponse**: string? - JSON response from AI Search (if used)
- **SelectedSource**: SearchSource - Which source provided the final answer
- **ConfidenceScore**: decimal - Confidence score of selected answer
- **ResponseTimeMs**: int - Total response time for dual search
- **Language**: string - Query language (en, af)
- **WasHelpful**: bool? - User feedback on answer quality
- **SearchTimestamp**: DateTime - When search occurred
- **ConversationId**: int? - Link to conversation if available
- **TenantId**: Guid - Multi-tenant isolation
[Source: docs/architecture/data-models.md patterns]

**SearchSource Enum**:
```csharp
public enum SearchSource
{
    LanguageStudio,
    AzureAISearch,
    Both
}
```

### Enhanced KnowledgeBasePlugin Architecture

**Dual Azure Services Strategy Implementation**:
```csharp
[KernelFunction("SearchKnowledge")]
[Description("Search both Azure Language Studio Q&A and PDF documents for comprehensive issue resolution")]
public async Task<string> SearchKnowledgeAsync(
    [Description("User question or issue description")] string query,
    [Description("Issue category for targeted search")] string? category = null,
    [Description("Preferred language (en/af)")] string language = "en"
)
{
    var startTime = DateTime.UtcNow;
    
    // Phase 1: Query Azure Language Studio (managed Q&A, fast response)
    var languageStudioResponse = await _azureLanguageService.QueryKnowledgeBaseAsync(query, language);
    
    if (languageStudioResponse.ConfidenceScore >= 0.5) // Configurable threshold
    {
        await TrackAnalytics(query, SearchSource.LanguageStudio, languageStudioResponse, null, startTime);
        return FormatLanguageStudioResponse(languageStudioResponse);
    }
    
    // Phase 2: Fallback to Azure AI Search for PDF documents
    var searchResponse = await FindHR(query); // Existing implementation
    await TrackAnalytics(query, SearchSource.AzureAISearch, languageStudioResponse, searchResponse, startTime);
    
    return searchResponse;
}

// Keep existing FindHR function for direct PDF search
[KernelFunction("FindHR")]
// ... existing implementation unchanged
```

**Azure Language Service Integration**:
```csharp
public interface IAzureLanguageService
{
    Task<LanguageStudioResponse> QueryKnowledgeBaseAsync(string query, string language = "en");
    Task<bool> SubmitFeedbackAsync(string queryId, bool wasHelpful);
}

public class LanguageStudioResponse
{
    public string Answer { get; set; }
    public decimal ConfidenceScore { get; set; }
    public string QueryId { get; set; }
    public List<string> Questions { get; set; }
    public string Language { get; set; }
}
```

**Integration with Existing Bot Infrastructure**:
- **Bot Project Autonomy**: `IAzureLanguageService` implemented directly in Bot project (`src/Bot/Services/`)
- **No Application Layer Dependency**: Bot remains architecturally independent, communicates via HTTP APIs
- **Enhanced KnowledgeBasePlugin**: Inject `IAzureLanguageService` into existing plugin constructor
- **Preserved Existing Functionality**: Maintains current Azure AI Search and SAS URI generation unchanged
- **API Communication**: Analytics tracked by HTTP calls to UI project controller endpoints
- **Configuration**: Language Studio settings in `src/Bot/appsettings.json` alongside existing Azure AI Search config

### API Specifications

**CQRS Command Pattern**:
- All commands inherit from `ICacheInvalidatorRequest<Result<T>>` for cache management
- Use `Result<T>` pattern for consistent error handling [Source: existing CQRS implementations]
- Commands include validation using FluentValidation [Source: established patterns]

**CQRS Query Pattern**:
- Queries inherit from `ICacheableRequest<Result<T>>` for performance optimization
- Use `ProjectTo<CuratedQADto>()` for efficient data mapping [Source: existing query patterns]
- Implement full-text search with confidence scoring for Q&A matching

### Component Specifications

**Blazor Component Dependencies**:
```razor
@inject IMediator Mediator
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IPermissionService PermissionService
@inject IStringLocalizer<KnowledgeBaseArticles> L
@inject NavigationManager Navigation
```
[Source: existing component patterns]

**MudBlazor Components for Knowledge Base UI**:
- Use `MudDataGrid` for article listing with sorting and filtering
- Use `MudRichTextEditor` for content creation and editing
- Use `MudTabs` for organizing article views (content, tags, versions, analytics)
- Use `MudChip` for tag display and management
- Use `MudExpansionPanels` for version history display
- Use `MudAutocomplete` for tag input with suggestions
[Source: docs/architecture/components.md]

### File Locations

**Bot Project Files to Create**:
- `src/Bot/Services/IAzureLanguageService.cs` - Interface for Custom Question Answering API
- `src/Bot/Services/AzureLanguageService.cs` - Implementation of Language Studio integration
- `src/Bot/Models/LanguageStudioResponse.cs` - Response model for Q&A API calls

**Bot Project Files to Modify**:
- `src/Bot/Plugins/KnowledgeBasePlugin.cs` - Add dual-source search with Language Studio integration
- `src/Bot/appsettings.json` - Add Language Studio configuration settings
- `src/Bot/Program.cs` or `src/Bot/Startup.cs` - Register `IAzureLanguageService` in DI container
- `src/Bot/IssueManager.Bot.csproj` - Add `Azure.AI.Language.QuestionAnswering` NuGet package

**Application Layer Files to Create**:
- `src/Domain/Entities/KnowledgeSearchAnalytics.cs` - Analytics tracking entity
- `src/Domain/Enums/SearchSource.cs` - Enum for search source tracking
- `src/Infrastructure/Persistence/Configurations/KnowledgeSearchAnalyticsConfiguration.cs` - EF configuration
- `src/Application/Features/KnowledgeBase/Commands/LogSearch/LogKnowledgeSearchCommand.cs` - Analytics logging
- `src/Application/Features/KnowledgeBase/Queries/GetAnalytics/GetKnowledgeAnalyticsQuery.cs` - Analytics reporting
- `src/Application/Features/KnowledgeBase/DTOs/KnowledgeSearchAnalyticsDto.cs` - Analytics DTO

**UI Project Files to Create**:
- `src/Server.UI/Controllers/KnowledgeBaseController.cs` - API endpoint for Bot analytics logging
- `src/Server.UI/Pages/Analytics/KnowledgeBaseAnalytics.razor` - Analytics dashboard page

**Application Layer Files to Modify**:
- `src/Application/Common/Interfaces/IApplicationDbContext.cs` - Add KnowledgeSearchAnalytics DbSet
- `src/Infrastructure/Persistence/ApplicationDbContext.cs` - Add KnowledgeSearchAnalytics DbSet
- Database migration files for analytics tracking

### Technical Constraints

**Database Access Pattern (CRITICAL)**:
- **ALWAYS use `IApplicationDbContextFactory` for database access in handlers** [Source: coding standards]
- Use `await using var db = await _dbContextFactory.CreateAsync(ct);` pattern
- Ensure proper disposal and connection management [Source: established patterns]

**Multi-Tenant Isolation (CRITICAL)**:
- All queries must include tenant filtering [Source: coding standards]
- Use tenant-aware entity configurations [Source: existing configurations]
- Implement tenant isolation in all CQRS handlers

**Performance Considerations**:
- Implement full-text search indexing for article content and titles
- Use efficient pagination for large article collections
- Cache frequently accessed articles for improved response times
- Index tag names and weights for fast matching algorithms

**Security Requirements**:
- Implement proper permission checks for article management operations
- Ensure only authorized users can approve article changes
- Validate all user input for XSS prevention in rich text content
- Implement audit logging for article changes and approvals

### Testing

**Test File Locations**:
- `tests/Domain.UnitTests/Entities/KnowledgeBaseArticleTests.cs` - Entity validation
- `tests/Application.UnitTests/Features/KnowledgeBase/Commands/CreateArticleCommandHandlerTests.cs`
- `tests/Application.UnitTests/Features/KnowledgeBase/Queries/GetArticlesQueryHandlerTests.cs`
- `tests/Application.IntegrationTests/Features/KnowledgeBase/KnowledgeBaseIntegrationTests.cs`
- `tests/Server.UI.Tests/Pages/KnowledgeBase/KnowledgeBaseArticlesTests.cs`

**Testing Standards**:
- Use TestBase pattern for integration tests with database setup [Source: testing strategy]
- Mock `IApplicationDbContextFactory` in unit tests [Source: established testing patterns]
- Test multi-tenant isolation in all query and command tests
- Use FluentAssertions for readable test assertions [Source: testing strategy]
- Test permission enforcement for all management operations

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-07 | 1.0 | Initial story creation for knowledge base foundation | Bob (Scrum Master) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

## QA Results

*This section will be populated by the QA agent after implementation review*