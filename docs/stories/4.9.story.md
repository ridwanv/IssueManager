# Story 4.9: Customer Resolution Feedback Collection via WhatsApp

## Status
**Draft**

## Story
**As a** customer who received a resolution to my issue,  
**I want** to provide feedback on the quality and effectiveness of the solution via WhatsApp,  
**so that** I can confirm the issue is truly resolved and help improve the support service quality.

## Acceptance Criteria
1. Automated WhatsApp message sent to customers 24 hours after conversation is marked as "Resolved" asking for feedback
2. Simple feedback options via WhatsApp quick reply buttons: "Issue Resolved ✅", "Still Having Issues ❌", "Partially Fixed ⚠️"
3. Follow-up message for customers who select "Still Having Issues" to automatically reopen conversation and notify agents
4. Optional satisfaction rating request (1-5 stars) after customers confirm resolution with thumbs up/down reaction support
5. Feedback data stored and linked to conversation records for agent performance analytics
6. Configurable feedback request timing (24h default) per tenant with ability to disable for specific conversation types
7. Feedback summary dashboard for support managers showing resolution effectiveness and customer satisfaction trends
8. Integration with conversation wrap-up data from Story 4.8 to correlate agent resolution categories with customer feedback

## Tasks / Subtasks

- [ ] **Create Customer Feedback Domain Models** (AC: 5, 8)
  - [ ] Add `CustomerFeedback` entity in `src/Domain/Entities/`
  - [ ] Create `FeedbackStatus` enum (Resolved, StillHasIssues, PartiallyFixed)
  - [ ] Create `SatisfactionRating` enum (1-5 stars with optional)
  - [ ] Link feedback entity to Conversation with foreign key relationship
  - [ ] Create database migration for feedback tracking tables

- [ ] **Implement Scheduled Feedback Request System** (AC: 1, 6)
  - [ ] Create `ScheduleFeedbackRequestCommand` triggered when conversation is marked as resolved
  - [ ] Add background job using Hangfire/Quartz to send delayed feedback requests
  - [ ] Create `SendFeedbackRequestCommand` for WhatsApp message delivery
  - [ ] Add tenant-specific configuration for feedback timing and enablement
  - [ ] Integrate with existing conversation completion workflow from Story 4.8

- [ ] **Build WhatsApp Feedback Collection Bot Logic** (AC: 2, 3, 4)
  - [ ] Extend `SemanticKernelBot` with feedback collection plugin
  - [ ] Create WhatsApp quick reply button templates for feedback options
  - [ ] Add feedback response parsing and validation in bot message handlers
  - [ ] Implement automatic conversation reopening for "Still Having Issues" responses
  - [ ] Add satisfaction rating collection with emoji/reaction support
  - [ ] Create feedback confirmation messages for completed responses

- [ ] **Create Feedback Management Commands** (AC: 3, 5)
  - [ ] Create `ProcessCustomerFeedbackCommand` for storing feedback responses
  - [ ] Create `ReopenConversationFromFeedbackCommand` for issue escalation
  - [ ] Add `NotifyAgentOfFeedbackEscalationCommand` for agent notifications
  - [ ] Integrate with existing SignalR notification system from Story 4.7
  - [ ] Ensure tenant isolation and proper audit trail creation

- [ ] **Build Feedback Analytics Dashboard** (AC: 7, 8)
  - [ ] Create `GetFeedbackAnalyticsQuery` for support manager insights
  - [ ] Create `FeedbackAnalyticsDto` with resolution effectiveness metrics
  - [ ] Add dashboard components in `src/Server.UI/Components/Analytics/`
  - [ ] Create feedback trends visualization with charts and graphs
  - [ ] Correlate feedback data with agent performance metrics from Story 4.8
  - [ ] Add filtering by date range, agent, resolution category, and feedback type

- [ ] **Enhance Agent Performance Integration** (AC: 8)
  - [ ] Extend `GetAgentCompletionStatsQuery` to include customer feedback metrics
  - [ ] Add feedback correlation to agent resolution category analysis
  - [ ] Create agent feedback dashboard showing customer satisfaction by resolution type
  - [ ] Add feedback-based performance indicators to agent profiles
  - [ ] Generate feedback improvement recommendations for agents

- [ ] **Add Configuration Management** (AC: 6)
  - [ ] Create tenant-level feedback configuration settings
  - [ ] Add admin interface for managing feedback timing and enablement
  - [ ] Create conversation type exclusions for feedback requests
  - [ ] Add feedback message template customization per tenant
  - [ ] Implement feedback request scheduling override capabilities

- [ ] **Testing and Validation** (All ACs)
  - [ ] Unit tests for feedback domain models and validation
  - [ ] Integration tests for scheduled feedback request system
  - [ ] Bot integration tests for WhatsApp feedback collection
  - [ ] Component tests for feedback analytics dashboard
  - [ ] End-to-end tests for complete feedback workflow

## Dev Notes

### Previous Story Insights
From Story 4.8 implementation:
- **Conversation Completion System**: Complete conversation wrap-up with resolution categories and notes [Source: docs/stories/4.8.story.md]
- **Resolution Categories**: Enum with Resolved, EscalatedToTechnicalTeam, InformationProvided, etc. [Source: docs/stories/4.8.story.md]
- **WhatsApp Notification Infrastructure**: Integration with Bot Framework for customer communication [Source: docs/stories/4.8.story.md]
- **Agent Performance Analytics**: Foundation for completion statistics and metrics [Source: docs/stories/4.8.story.md]

From Story 4.7 implementation:
- **SignalR Real-time System**: Complete agent notification and real-time update infrastructure [Source: docs/stories/4.7.real-time-chat-updates.md]
- **Background Job Infrastructure**: Established pattern for delayed and scheduled operations [Source: docs/stories/4.7.real-time-chat-updates.md]

From Epic 4.2 requirements:
- **Resolution Quality Tracking**: Explicit requirement for user satisfaction feedback collection [Source: docs/prd/epic-4-complete-workflow-communication-loop.md:31]
- **User Confirmation Workflow**: Framework for customer response handling [Source: docs/prd/epic-4-complete-workflow-communication-loop.md:28]

### Data Models

**New CustomerFeedback Entity**:
```csharp
public class CustomerFeedback : BaseAuditableEntity, IMustHaveTenant
{
    public Guid Id { get; set; }
    public string ConversationReference { get; set; } // FK to Conversation
    public FeedbackStatus Status { get; set; }
    public SatisfactionRating? Rating { get; set; } // Optional 1-5 rating
    public string? Comments { get; set; } // Optional customer comments
    public DateTime RequestedAt { get; set; }
    public DateTime? RespondedAt { get; set; }
    public bool ConversationReopened { get; set; }
    public string TenantId { get; set; }
}
```

**New Enums**:
```csharp
public enum FeedbackStatus
{
    Pending = 0,
    IssueResolved = 1,
    StillHasIssues = 2,
    PartiallyFixed = 3,
    NoResponse = 4
}

public enum SatisfactionRating
{
    OneStar = 1,
    TwoStars = 2,
    ThreeStars = 3,
    FourStars = 4,
    FiveStars = 5
}
```

**Enhanced Analytics DTOs**:
```csharp
public class FeedbackAnalyticsDto
{
    public double OverallSatisfactionScore { get; set; }
    public int TotalFeedbackResponses { get; set; }
    public int ReopenedConversations { get; set; }
    public Dictionary<ResolutionCategory, FeedbackSummary> FeedbackByCategory { get; set; }
    public List<AgentFeedbackMetrics> AgentPerformance { get; set; }
}
```

### API Specifications

**New CQRS Commands**:
- **ScheduleFeedbackRequestCommand**: `ICacheInvalidatorRequest<Result<Unit>>` for scheduling feedback requests [Source: docs/architecture/coding-standards.md]
- **SendFeedbackRequestCommand**: `ICacheInvalidatorRequest<Result<bool>>` for WhatsApp message delivery [Source: docs/architecture/coding-standards.md]
- **ProcessCustomerFeedbackCommand**: `ICacheInvalidatorRequest<Result<CustomerFeedback>>` for feedback processing [Source: docs/architecture/coding-standards.md]
- **ReopenConversationFromFeedbackCommand**: `ICacheInvalidatorRequest<Result<bool>>` for automatic reopening [Source: docs/architecture/coding-standards.md]

**New CQRS Queries**:
- **GetFeedbackAnalyticsQuery**: `ICacheableRequest<Result<FeedbackAnalyticsDto>>` for dashboard data [Source: docs/architecture/coding-standards.md]
- **GetPendingFeedbackRequestsQuery**: `ICacheableRequest<Result<List<CustomerFeedback>>>` for background job processing [Source: docs/architecture/coding-standards.md]

**Enhanced Bot Framework Integration**:
- **FeedbackCollectionPlugin**: Semantic Kernel plugin for processing customer feedback responses
- **WhatsApp Quick Reply Templates**: Structured message templates with action buttons
- **Feedback Response Parser**: Logic to interpret customer responses and map to feedback status

### File Locations

**Files to Create**:
- `src/Domain/Entities/CustomerFeedback.cs` - New feedback entity [Source: docs/architecture/unified-project-structure.md#entities]
- `src/Domain/Enums/FeedbackStatus.cs` - Feedback status enumeration [Source: docs/architecture/unified-project-structure.md#enums]
- `src/Domain/Enums/SatisfactionRating.cs` - Rating enumeration [Source: docs/architecture/unified-project-structure.md#enums]
- `src/Application/Features/Feedback/Commands/ScheduleFeedbackRequest/ScheduleFeedbackRequestCommand.cs` - Scheduling command [Source: docs/architecture/unified-project-structure.md#cqrs-handlers]
- `src/Application/Features/Feedback/Commands/ScheduleFeedbackRequest/ScheduleFeedbackRequestCommandHandler.cs` - Handler
- `src/Application/Features/Feedback/Commands/SendFeedbackRequest/SendFeedbackRequestCommand.cs` - WhatsApp sending [Source: docs/architecture/unified-project-structure.md#cqrs-handlers]
- `src/Application/Features/Feedback/Commands/SendFeedbackRequest/SendFeedbackRequestCommandHandler.cs` - Handler
- `src/Application/Features/Feedback/Commands/ProcessCustomerFeedback/ProcessCustomerFeedbackCommand.cs` - Response processing [Source: docs/architecture/unified-project-structure.md#cqrs-handlers]
- `src/Application/Features/Feedback/Commands/ProcessCustomerFeedback/ProcessCustomerFeedbackCommandHandler.cs` - Handler
- `src/Application/Features/Feedback/Queries/GetFeedbackAnalytics/GetFeedbackAnalyticsQuery.cs` - Analytics query [Source: docs/architecture/unified-project-structure.md#cqrs-handlers]
- `src/Application/Features/Feedback/Queries/GetFeedbackAnalytics/GetFeedbackAnalyticsQueryHandler.cs` - Handler
- `src/Application/Features/Feedback/DTOs/FeedbackAnalyticsDto.cs` - Analytics DTO [Source: docs/architecture/unified-project-structure.md#dtos]
- `src/Application/Features/Feedback/DTOs/CustomerFeedbackDto.cs` - Feedback DTO [Source: docs/architecture/unified-project-structure.md#dtos]
- `src/Server.UI/Components/Analytics/FeedbackAnalyticsDashboard.razor` - Dashboard component [Source: docs/architecture/unified-project-structure.md#components]
- `src/Server.UI/Pages/Analytics/FeedbackReports.razor` - Feedback reports page [Source: docs/architecture/unified-project-structure.md#components]
- `src/Bot/Plugins/FeedbackCollectionPlugin.cs` - Bot feedback plugin [Source: docs/architecture/unified-project-structure.md#bot-plugins]
- `src/Infrastructure/BackgroundJobs/ProcessFeedbackRequestsJob.cs` - Background job for scheduled feedback [Source: docs/architecture/unified-project-structure.md#background-jobs]

**Files to Modify**:
- `src/Application/Features/Conversations/Commands/CompleteConversation/CompleteConversationCommandHandler.cs` - Add feedback scheduling [Source: docs/stories/4.8.story.md]
- `src/Bot/Bots/SemanticKernelBot.cs` - Integrate feedback collection plugin [Source: src/Bot/Bots/SemanticKernelBot.cs]
- `src/Infrastructure/Persistence/ApplicationDbContext.cs` - Add CustomerFeedback DbSet [Source: src/Infrastructure/Persistence/ApplicationDbContext.cs]
- `src/Infrastructure/Persistence/Configurations/CustomerFeedbackConfiguration.cs` - Entity configuration [Source: docs/architecture/unified-project-structure.md#entity-configurations]

### Component Specifications

**WhatsApp Feedback Request Template**:
```
Hi! 👋 

We recently resolved your support request. We'd love to know how we did!

Please let us know:
• ✅ Issue Resolved - Everything is working perfectly
• ❌ Still Having Issues - Need more help
• ⚠️ Partially Fixed - Some progress but not complete

Your feedback helps us improve our service quality.

Thank you! 🙏
```

**FeedbackAnalyticsDashboard.razor Template**:
```razor
@using CleanArchitecture.Blazor.Application.Features.Feedback.Queries.GetFeedbackAnalytics
@inject IMediator Mediator

<MudContainer MaxWidth="MaxWidth.Large">
    <MudGrid>
        <MudItem xs="12" md="3">
            <MudPaper Class="pa-4">
                <div class="d-flex align-center">
                    <MudIcon Icon="@Icons.Material.Filled.Star" Color="Color.Warning" Size="Size.Large" />
                    <div class="ml-3">
                        <MudText Typo="Typo.h4">@analytics.OverallSatisfactionScore.ToString("F1")</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Overall Satisfaction</MudText>
                    </div>
                </div>
            </MudPaper>
        </MudItem>
        
        <MudItem xs="12" md="3">
            <MudPaper Class="pa-4">
                <div class="d-flex align-center">
                    <MudIcon Icon="@Icons.Material.Filled.Feedback" Color="Color.Info" Size="Size.Large" />
                    <div class="ml-3">
                        <MudText Typo="Typo.h4">@analytics.TotalFeedbackResponses</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Total Responses</MudText>
                    </div>
                </div>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="6">
            <MudChart ChartType="ChartType.Donut"
                     InputData="@feedbackChartData"
                     InputLabels="@feedbackChartLabels"
                     Width="400px" Height="300px" />
        </MudItem>
    </MudGrid>
</MudContainer>
```
[Source: docs/architecture/frontend-architecture.md#component-template]

### Technical Constraints

**Database Access Pattern (CRITICAL)**:
- **ALWAYS use `IApplicationDbContextFactory` for database access** [Source: docs/architecture/coding-standards.md#database-access-pattern]
- Use proper navigation properties between CustomerFeedback and Conversation entities [Source: docs/architecture/coding-standards.md#database-access-pattern]
- Implement efficient querying for analytics with proper indexing [Source: docs/architecture/coding-standards.md#database-access-pattern]

**Multi-Tenant Isolation (CRITICAL)**:
- All feedback operations must include tenant filtering [Source: docs/architecture/coding-standards.md#tenant-isolation]
- Ensure feedback requests only go to customers within the same tenant [Source: docs/architecture/coding-standards.md#tenant-isolation]
- Analytics dashboards must be tenant-scoped [Source: docs/architecture/coding-standards.md#tenant-isolation]

**Background Job Processing**:
- Use existing background job infrastructure (Hangfire/Quartz) for scheduled feedback requests
- Implement retry logic for failed WhatsApp message delivery
- Add job monitoring and failure notification for critical feedback operations
- Ensure background jobs respect tenant context and database connection management

**WhatsApp Integration Constraints**:
- Follow WhatsApp Business API rate limiting and message templates [Source: src/Bot/Controllers/BotController.cs]
- Ensure feedback messages comply with WhatsApp policy requirements
- Handle message delivery failures and user opt-out scenarios
- Respect customer communication preferences and Do Not Disturb settings

### Permission System Integration

**New Permissions Required**:
- **Feedback.View**: Access to feedback analytics and reports
- **Feedback.Manage**: Ability to configure feedback settings and timing
- **Analytics.ViewFeedback**: Permission to view customer satisfaction metrics
- **Conversations.ViewFeedback**: Access to feedback data within conversation context

**Permission Checks**:
- Add authorization to feedback analytics dashboard and configuration pages
- Ensure agents can only view feedback for conversations within their tenant
- Use existing permission service patterns for consistent authorization [Source: docs/architecture/coding-standards.md#permission-checks]

### Architecture Alignment

**Clean Architecture Compliance**:
- Domain layer contains feedback entities and business rules [Source: docs/architecture/backend-architecture.md]
- Application layer handles feedback processing and analytics [Source: docs/architecture/backend-architecture.md]
- Infrastructure layer manages WhatsApp integration and background jobs [Source: docs/architecture/backend-architecture.md]
- UI layer presents analytics and configuration interfaces [Source: docs/architecture/frontend-architecture.md]

**Event-Driven Architecture**:
- Generate domain events for feedback received and conversation reopening
- Integrate with existing audit trail system for compliance tracking
- Use SignalR for real-time feedback notifications to agents and managers

**Integration with Existing Systems**:
- Build on conversation completion system from Story 4.8
- Extend agent performance analytics with customer satisfaction metrics
- Leverage existing WhatsApp infrastructure and bot framework capabilities
- Maintain consistency with resolution category correlation from Story 4.8

## Testing

### Test File Locations

**Domain Tests**:
- `tests/Domain.UnitTests/Entities/CustomerFeedbackTests.cs` - Feedback entity validation tests [Source: docs/architecture/testing-strategy.md#test-organization]

**Command Handler Tests**:
- `tests/Application.UnitTests/Features/Feedback/Commands/ScheduleFeedbackRequestCommandHandlerTests.cs` - Scheduling logic tests [Source: docs/architecture/testing-strategy.md#test-organization]
- `tests/Application.UnitTests/Features/Feedback/Commands/ProcessCustomerFeedbackCommandHandlerTests.cs` - Feedback processing tests [Source: docs/architecture/testing-strategy.md#test-organization]
- `tests/Application.UnitTests/Features/Feedback/Commands/SendFeedbackRequestCommandHandlerTests.cs` - WhatsApp integration tests [Source: docs/architecture/testing-strategy.md#test-organization]

**Query Handler Tests**:
- `tests/Application.UnitTests/Features/Feedback/Queries/GetFeedbackAnalyticsQueryHandlerTests.cs` - Analytics calculation tests [Source: docs/architecture/testing-strategy.md#test-organization]

**Component Tests**:
- `tests/Server.UI.Tests/Components/Analytics/FeedbackAnalyticsDashboardTests.cs` - Dashboard component tests [Source: docs/architecture/testing-strategy.md#test-organization]

**Integration Tests**:
- `tests/Application.IntegrationTests/Features/Feedback/FeedbackWorkflowIntegrationTests.cs` - End-to-end feedback tests [Source: docs/architecture/testing-strategy.md#test-organization]
- `tests/Bot.IntegrationTests/Plugins/FeedbackCollectionPluginTests.cs` - Bot feedback collection tests [Source: docs/architecture/testing-strategy.md#test-organization]

**Background Job Tests**:
- `tests/Infrastructure.UnitTests/BackgroundJobs/ProcessFeedbackRequestsJobTests.cs` - Background job execution tests [Source: docs/architecture/testing-strategy.md#test-organization]

### Testing Standards

**Frontend Testing Framework**:
- Use bUnit for Blazor component testing of analytics dashboard [Source: docs/architecture/tech-stack.md#frontend-testing]
- Test chart rendering and data visualization components [Source: docs/architecture/testing-strategy.md#test-organization]
- Mock MediatR for analytics query testing [Source: docs/architecture/testing-strategy.md#test-organization]

**Backend Testing Framework**:
- Use xUnit + FluentAssertions for command/query handler tests [Source: docs/architecture/tech-stack.md#backend-testing]
- Mock `IApplicationDbContextFactory` and WhatsApp services in unit tests [Source: docs/architecture/testing-strategy.md]
- Use TestBase class for integration tests with database and background job setup [Source: docs/architecture/testing-strategy.md]

**Testing Requirements**:
- Test all feedback status transitions and validation scenarios
- Test WhatsApp message template generation and delivery
- Test scheduled feedback request timing and execution
- Test conversation reopening logic from negative feedback
- Test analytics calculation accuracy with various data scenarios
- Test tenant isolation for all feedback operations
- Test background job retry logic and error handling
- Test bot feedback collection with various customer response patterns
- Test correlation between resolution categories and feedback metrics
- Test configuration management and tenant-specific settings

**Performance Testing**:
- Test analytics query performance with large feedback datasets
- Test background job processing efficiency with high volume
- Test dashboard loading times with comprehensive data visualizations
- Test WhatsApp API rate limiting and message queuing

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-08 | 1.0 | Initial story creation for customer resolution feedback collection via WhatsApp | Bob (Scrum Master) |