# Story 2.3: Issue Contact Management & Linking

## Status
**Draft**

## Story
**As a** support staff member,  
**I want** to create new contacts or link existing contacts to issues during issue creation and management,  
**so that** I can maintain complete contact information and establish proper relationships between contacts and their reported issues.

## Acceptance Criteria
1. Contact selection/creation during issue creation process with dropdown showing existing contacts and "Create New Contact" option
2. Search existing contacts by name, email, or phone number with real-time filtering in contact selection interface  
3. Create new contact inline during issue creation without leaving the issue creation workflow
4. Edit contact information directly from issue detail view with navigation to contact management pages
5. Display complete contact information (name, email, phone, preferred language) in issue detail view
6. Link multiple issues to the same contact with proper relationship management and contact history
7. Contact validation ensuring required fields and proper data format (email validation, phone number formatting)
8. Update issue's contact assignment with audit trail logging for contact changes

## Tasks / Subtasks

- [ ] **Create Contact Selection Component** (AC: 1, 2)
  - [ ] Create `ContactSelectorComponent.razor` with MudAutocomplete for contact selection
  - [ ] Implement real-time contact search functionality with name, email, phone filtering
  - [ ] Add "Create New Contact" option that triggers inline contact creation dialog
  - [ ] Handle contact selection events and emit ContactSelected events to parent components
  - [ ] Add loading states and error handling for contact search operations

- [ ] **Create Inline Contact Creation Dialog** (AC: 3, 7)
  - [ ] Create `CreateContactDialog.razor` for inline contact creation during issue workflow
  - [ ] Implement FluentValidation for contact data with email validation and phone number formatting
  - [ ] Add form fields for Name, Email, PhoneNumber, PreferredLanguage with proper validation messages
  - [ ] Handle successful contact creation and return new contact data to calling component
  - [ ] Add integration with existing `AddEditContactCommand` from Contact management

- [ ] **Enhance Issue Creation Process** (AC: 1, 3)
  - [ ] Modify `CreateIssue.razor` page to include ContactSelectorComponent
  - [ ] Update `CreateIssueCommand` to handle ReporterContactId assignment from selected/created contact
  - [ ] Add validation to ensure contact is selected before issue creation
  - [ ] Handle inline contact creation workflow within issue creation process
  - [ ] Update issue creation success flow to show both issue and contact information

- [ ] **Enhance Issue Detail View** (AC: 4, 5)
  - [ ] Modify `Details.razor` to display complete contact information in dedicated contact section  
  - [ ] Add navigation link to contact detail page from issue detail view
  - [ ] Create `IssueContactInfoComponent.razor` for displaying contact information with edit capabilities
  - [ ] Add "Edit Contact" button that navigates to contact edit page or opens edit dialog
  - [ ] Ensure contact information loads with issue detail query for efficient data display

- [ ] **Implement Contact Assignment Updates** (AC: 6, 8)
  - [ ] Create `UpdateIssueContactCommand` for changing issue contact assignment
  - [ ] Create `UpdateIssueContactCommandHandler` with validation and audit trail logging
  - [ ] Add contact change functionality to issue management interface
  - [ ] Implement audit trail logging for contact assignment changes in EventLog
  - [ ] Handle edge cases for contact deletion and issue reassignment

- [ ] **Create Contact History Display** (AC: 6)
  - [ ] Create `ContactIssueHistoryQuery` to retrieve all issues for a specific contact  
  - [ ] Create `ContactIssueHistoryQueryHandler` with tenant isolation and pagination support
  - [ ] Add issue history section to contact detail view showing related issues
  - [ ] Create `ContactIssueHistoryComponent.razor` for displaying contact's issue history
  - [ ] Add navigation from contact history to specific issue detail views

- [ ] **Add Contact Validation Services** (AC: 7)
  - [ ] Create `ContactValidator` class using FluentValidation with comprehensive validation rules
  - [ ] Implement email format validation with proper regex patterns
  - [ ] Add phone number validation and formatting for international numbers
  - [ ] Create validation for preferred language selection and name requirements
  - [ ] Add duplicate contact detection based on email and phone number combinations

- [ ] **Testing and Integration** (All ACs)
  - [ ] Unit tests for ContactSelectorComponent with search functionality
  - [ ] Unit tests for CreateContactDialog validation and form submission
  - [ ] Integration tests for issue-contact linking workflow
  - [ ] Component tests for contact information display in issue details
  - [ ] Command handler tests for contact assignment and audit logging

## Dev Notes

### Previous Story Insights
From Story 2.2 implementation:
- **Issue Detail View**: Complete issue details view with management capabilities including contact display [Source: docs/stories/2.2.story.md]
- **IApplicationDbContextFactory Pattern**: Established database access pattern for all handlers [Source: docs/stories/2.2.story.md]
- **Multi-tenant Isolation**: Working tenant filtering via IUserContextAccessor [Source: docs/stories/2.2.story.md]
- **Issue Entity Structure**: Issue.ReporterContactId field exists for contact linking [Source: docs/stories/2.2.story.md]
- **SignalR Infrastructure**: Real-time update system available for contact change notifications [Source: docs/stories/2.2.story.md]

From existing Contact system:
- **Contact CRUD Operations**: Complete contact management system with AddEditContactCommand, ContactsWithPaginationQuery [Source: src/Server.UI/Pages/Contacts/Contacts.razor]
- **Contact Permissions**: Contacts.View, Contacts.Create, Contacts.Edit, Contacts.Delete permissions are operational [Source: src/Server.UI/Pages/Contacts/Contacts.razor]
- **Contact Entity**: Name, Email, PhoneNumber, Country, Description fields with validation [Source: src/Server.UI/Pages/Contacts/Contacts.razor]

### Data Models

**Contact Entity for Issue Linking**:
- **Contact.Id**: GUID primary identifier for issue relationships [Source: docs/architecture/data-models.md#contact]
- **Contact.Name**: Display name for contact selection and issue display [Source: docs/architecture/data-models.md#contact]
- **Contact.Email**: Email for validation and duplicate detection [Source: docs/architecture/data-models.md#contact]
- **Contact.PhoneNumber**: Phone number with E.164 formatting [Source: docs/architecture/data-models.md#contact]
- **Contact.PreferredLanguage**: Language enum for communication preferences [Source: docs/architecture/data-models.md#contact]
- **Contact.TenantId**: Multi-tenant isolation for contact selection [Source: docs/architecture/data-models.md#contact]

**Issue-Contact Relationship**:
- **Issue.ReporterContactId**: Foreign key relationship to Contact entity [Source: docs/architecture/data-models.md#issue]
- **Navigation Properties**: Issue.ReporterContact and Contact.Issues collections [Source: docs/architecture/data-models.md#issue]

### API Specifications

**New CQRS Commands**:
- **UpdateIssueContactCommand**: `ICacheInvalidatorRequest<Result<Unit>>` for contact assignment changes [Source: docs/architecture/coding-standards.md]
- **ValidateContactCommand**: `IRequest<Result<ValidationResult>>` for contact data validation [Source: docs/architecture/coding-standards.md]

**New CQRS Queries**:
- **SearchContactsQuery**: `ICacheableRequest<Result<List<ContactSearchDto>>>` for contact selection [Source: docs/architecture/coding-standards.md]
- **GetContactIssueHistoryQuery**: `ICacheableRequest<Result<PaginatedResult<IssueDto>>>` for contact history [Source: docs/architecture/coding-standards.md]

**Enhanced DTOs**:
- **ContactSearchDto**: Lightweight DTO for contact selection with Id, Name, Email, PhoneNumber
- **IssueDetailDto Enhancement**: Include complete ReporterContact information with navigation properties
- **ContactIssueHistoryDto**: Contact information with paginated issue list for history display

### Component Specifications

**ContactSelectorComponent.razor Template**:
```razor
@inject IMediator Mediator
@inject IDialogService DialogService

<MudAutocomplete T="ContactSearchDto"
                 Label="Select Contact"
                 @bind-Value="SelectedContact"
                 SearchFunc="SearchContacts"
                 ToStringFunc="contact => $"{contact.Name} ({contact.Email})"
                 ShowProgressIndicator="true"
                 MinCharacters="2">
    <ItemTemplate Context="contact">
        <MudStack Row AlignItems="AlignItems.Center">
            <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" />
            <MudStack Spacing="0">
                <MudText Typo="Typo.body1">@contact.Name</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">@contact.Email</MudText>
            </MudStack>
        </MudStack>
    </ItemTemplate>
    <MoreItemsTemplate>
        <MudMenuItem OnClick="OpenCreateContactDialog">
            <MudStack Row AlignItems="AlignItems.Center">
                <MudIcon Icon="@Icons.Material.Filled.Add" Color="Color.Primary" />
                <MudText Color="Color.Primary">Create New Contact</MudText>
            </MudStack>
        </MudMenuItem>
    </MoreItemsTemplate>
</MudAutocomplete>
```
[Source: docs/architecture/frontend-architecture.md#component-template]

**CreateContactDialog.razor Template**:
```razor
<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">Create New Contact</MudText>
    </TitleContent>
    <DialogContent>
        <MudForm @ref="form" Model="ContactModel" Validation="validator">
            <MudTextField @bind-Value="ContactModel.Name"
                         Label="Full Name"
                         Required="true"
                         For="@(() => ContactModel.Name)" />
            
            <MudTextField @bind-Value="ContactModel.Email"
                         Label="Email Address"
                         InputType="InputType.Email"
                         For="@(() => ContactModel.Email)" />
            
            <MudTextField @bind-Value="ContactModel.PhoneNumber"
                         Label="Phone Number"
                         For="@(() => ContactModel.PhoneNumber)" />
            
            <MudSelect @bind-Value="ContactModel.PreferredLanguage"
                       Label="Preferred Language">
                <MudSelectItem Value="Language.English">English</MudSelectItem>
                <MudSelectItem Value="Language.Afrikaans">Afrikaans</MudSelectItem>
            </MudSelect>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" OnClick="SaveContact" Disabled="!form.IsValid">Create</MudButton>
    </DialogActions>
</MudDialog>
```
[Source: docs/architecture/frontend-architecture.md#component-template]

### File Locations

**Files to Create**:
- `src/Application/Features/Contacts/Queries/SearchContacts/SearchContactsQuery.cs` - Contact search query [Source: docs/architecture/unified-project-structure.md#cqrs-handlers]
- `src/Application/Features/Contacts/Queries/SearchContacts/SearchContactsQueryHandler.cs` - Search handler
- `src/Application/Features/Contacts/Queries/GetContactIssueHistory/GetContactIssueHistoryQuery.cs` - Contact history query [Source: docs/architecture/unified-project-structure.md#cqrs-handlers]
- `src/Application/Features/Contacts/Queries/GetContactIssueHistory/GetContactIssueHistoryQueryHandler.cs` - History handler
- `src/Application/Features/Issues/Commands/UpdateIssueContact/UpdateIssueContactCommand.cs` - Contact assignment command [Source: docs/architecture/unified-project-structure.md#cqrs-handlers]
- `src/Application/Features/Issues/Commands/UpdateIssueContact/UpdateIssueContactCommandHandler.cs` - Assignment handler
- `src/Application/Features/Contacts/DTOs/ContactSearchDto.cs` - Search result DTO [Source: docs/architecture/unified-project-structure.md#dtos]
- `src/Application/Features/Contacts/DTOs/ContactIssueHistoryDto.cs` - History display DTO [Source: docs/architecture/unified-project-structure.md#dtos]
- `src/Application/Features/Contacts/Validators/ContactValidator.cs` - Contact validation service [Source: docs/architecture/unified-project-structure.md#validators]
- `src/Server.UI/Components/Contacts/ContactSelectorComponent.razor` - Contact selection component [Source: docs/architecture/unified-project-structure.md#components]
- `src/Server.UI/Components/Contacts/CreateContactDialog.razor` - Inline contact creation dialog [Source: docs/architecture/unified-project-structure.md#components]
- `src/Server.UI/Components/Issues/IssueContactInfoComponent.razor` - Issue contact display component [Source: docs/architecture/unified-project-structure.md#components]
- `src/Server.UI/Components/Contacts/ContactIssueHistoryComponent.razor` - Contact issue history component [Source: docs/architecture/unified-project-structure.md#components]

**Files to Modify**:
- `src/Server.UI/Pages/Issues/Create.razor` - Add contact selection to issue creation [Source: src/Server.UI/Pages/Issues/Create.razor]
- `src/Server.UI/Pages/Issues/Details.razor` - Add contact information display [Source: src/Server.UI/Pages/Issues/Details.razor]
- `src/Server.UI/Pages/Contacts/Details.razor` - Add issue history section [Source: src/Server.UI/Pages/Contacts/]
- `src/Application/Features/Issues/Commands/CreateIssue/CreateIssueCommand.cs` - Include ReporterContactId [Source: src/Application/Features/Issues/Commands/CreateIssue/]
- `src/Application/Features/Issues/DTOs/IssueDetailDto.cs` - Include complete contact information [Source: src/Application/Features/Issues/DTOs/]

### Technical Constraints

**Database Access Pattern (CRITICAL)**:
- **ALWAYS use `IApplicationDbContextFactory` for database access** [Source: docs/architecture/coding-standards.md#database-access-pattern]
- Use comprehensive `.Include(i => i.ReporterContact)` statements for issue queries [Source: docs/architecture/coding-standards.md#database-access-pattern]
- Implement efficient contact search with indexed queries on Name, Email, PhoneNumber [Source: docs/architecture/coding-standards.md#database-access-pattern]

**Multi-Tenant Isolation (CRITICAL)**:
- All contact operations must include tenant filtering [Source: docs/architecture/coding-standards.md#tenant-isolation]
- Contact search results must be scoped to current tenant only [Source: docs/architecture/coding-standards.md#tenant-isolation]
- Issue-contact relationships must respect tenant boundaries [Source: docs/architecture/coding-standards.md#tenant-isolation]

**Validation and Data Integrity**:
- Email validation using proper RFC-compliant regex patterns
- Phone number formatting using international E.164 format
- Duplicate detection based on email and phone combinations within tenant
- Required field validation for Name, optional for Email and Phone
- Language preference validation against supported Language enum values

**Component Integration Standards**:
- Use MudBlazor MudAutocomplete for consistent contact selection experience [Source: docs/architecture/frontend-architecture.md]
- Implement proper loading states and error handling in all components [Source: docs/architecture/frontend-architecture.md]
- Follow established dialog patterns for inline contact creation [Source: docs/architecture/frontend-architecture.md]
- Use consistent navigation patterns for contact detail links [Source: docs/architecture/frontend-architecture.md]

### Permission System Integration

**Required Permissions**:
- **Issues.Edit**: Required for updating issue contact assignments
- **Contacts.View**: Required for contact search and selection functionality
- **Contacts.Create**: Required for inline contact creation during issue workflow
- **Contacts.Edit**: Required for contact information updates from issue detail view

**Permission Checks**:
- Validate Contacts.Create permission before showing "Create New Contact" option
- Check Issues.Edit permission before allowing contact assignment changes
- Use Contacts.View permission for contact information display
- Apply Contacts.Edit permission for contact detail navigation links

### Performance Considerations

**Contact Search Optimization**:
- Implement debounced search with minimum 2 character requirement
- Use database indexing on Contact.Name, Contact.Email, Contact.PhoneNumber for fast searches
- Limit search results to reasonable number (e.g., 50 contacts) with pagination if needed
- Cache frequently searched contacts using `ICacheableRequest<T>` pattern

**Issue-Contact Relationship Loading**:
- Use `.Include()` statements efficiently to load contact information with issue queries
- Implement lazy loading for contact issue history to improve page load performance
- Use projection with `ProjectTo<T>()` for contact search results to minimize data transfer

## Testing

### Test File Locations

**Component Tests**:
- `tests/Server.UI.Tests/Components/Contacts/ContactSelectorComponentTests.cs` - Contact selection component tests [Source: docs/architecture/testing-strategy.md#test-organization]
- `tests/Server.UI.Tests/Components/Contacts/CreateContactDialogTests.cs` - Contact creation dialog tests [Source: docs/architecture/testing-strategy.md#test-organization]
- `tests/Server.UI.Tests/Components/Issues/IssueContactInfoComponentTests.cs` - Contact info display tests [Source: docs/architecture/testing-strategy.md#test-organization]

**Command Handler Tests**:
- `tests/Application.UnitTests/Features/Issues/Commands/UpdateIssueContactCommandHandlerTests.cs` - Contact assignment tests [Source: docs/architecture/testing-strategy.md#test-organization]
- `tests/Application.UnitTests/Features/Contacts/Queries/SearchContactsQueryHandlerTests.cs` - Contact search tests [Source: docs/architecture/testing-strategy.md#test-organization]

**Integration Tests**:
- `tests/Application.IntegrationTests/Features/Issues/IssueContactLinkingIntegrationTests.cs` - End-to-end linking tests [Source: docs/architecture/testing-strategy.md#test-organization]
- `tests/Server.UI.IntegrationTests/Workflows/ContactManagementWorkflowTests.cs` - Complete workflow tests [Source: docs/architecture/testing-strategy.md#test-organization]

**Validation Tests**:
- `tests/Application.UnitTests/Features/Contacts/Validators/ContactValidatorTests.cs` - Contact validation rule tests [Source: docs/architecture/testing-strategy.md#test-organization]

### Testing Standards

**Frontend Testing Framework**:
- Use bUnit for Blazor component testing with MudBlazor components [Source: docs/architecture/testing-strategy.md#test-organization]
- Mock IMediator for component tests to isolate UI logic [Source: docs/architecture/testing-strategy.md#test-organization]
- Test component parameter binding and event emission [Source: docs/architecture/testing-strategy.md#test-organization]

**Backend Testing Framework**:
- Use xUnit + FluentAssertions for command/query handler tests [Source: docs/architecture/testing-strategy.md#test-organization]
- Mock `IApplicationDbContextFactory` and related services [Source: docs/architecture/testing-strategy.md#test-organization]
- Use TestBase class for integration tests with database setup [Source: docs/architecture/testing-strategy.md#test-organization]

**Testing Requirements**:
- Test contact search functionality with various search terms
- Test inline contact creation with validation scenarios
- Test issue-contact linking and unlinking operations
- Test tenant isolation for all contact operations
- Test permission-based access control for contact management
- Test duplicate contact detection and prevention
- Test contact information display in issue detail view
- Test audit trail generation for contact assignment changes
- Test error handling for contact operations and API failures

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-08 | 1.0 | Initial story creation for issue-contact management and linking functionality | Bob (Scrum Master) |